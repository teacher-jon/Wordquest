<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WordCraft: Fixed & Polished</title>
    <style>
        :root { --bg-color: #1a1a2e; --ui-border: #5d4037; --accent: #d35400; }
        body { background-color: var(--bg-color); color: #2c3e50; font-family: 'Verdana', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 0; height: 100vh; overflow: hidden; user-select: none; touch-action: none; }
        #game-frame { position: relative; border: 4px solid var(--ui-border); border-radius: 4px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); line-height: 0; background: #000; cursor: crosshair; width: 100%; max-width: 800px; height: auto; aspect-ratio: 4/3; }
        canvas { display: block; image-rendering: pixelated; width: 100%; height: 100%; }
        
        #overlay-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .popup { pointer-events: auto; background: #fff; border: 4px solid var(--ui-border); padding: 20px; border-radius: 8px; text-align: center; max-width: 95%; display: none; box-shadow: 5px 5px 10px rgba(0,0,0,0.5); max-height: 95%; overflow-y: auto; line-height: 1.6 !important; }
        .popup.active { display: block; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* INVENTORY STYLES */
        #screen-inv { width: 700px; height: 550px; background-image: url('assets/bg.png'); background-color: #f3e5f5; background-size: cover; color: #3e2723; display: none; flex-direction: column; }
        #screen-inv.active { display: flex; }
        .forge-tabs { display: flex; border-bottom: 3px solid #5d4037; margin-bottom: 10px; background: rgba(0,0,0,0.1); }
        .tab { flex: 1; padding: 12px; cursor: pointer; font-weight: bold; background: rgba(255,255,255,0.4); border-right: 1px solid rgba(0,0,0,0.1); transition: 0.2s; }
        .tab:hover { background: rgba(255,255,255,0.7); }
        .tab.active { background: #fff; border-bottom: 3px solid #d35400; color: #d35400; transform: translateY(2px); }
        .crafting-grid { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px 0; }
        .craft-slot { width: 60px; height: 60px; border: 2px dashed #5d4037; display: flex; align-items: center; justify-content: center; font-weight: bold; background: rgba(255,255,255,0.5); cursor: pointer; border-radius: 8px; }
        .inv-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; flex: 1; overflow-y: auto; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }
        .inv-grid::-webkit-scrollbar { width: 8px; }
        .inv-grid::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .inv-grid::-webkit-scrollbar-thumb { background: #8d6e63; border-radius: 4px; }
        .word-chip { background: #fff; border: 2px solid #5d4037; padding: 6px 10px; border-radius: 15px; cursor: pointer; font-size: 12px; font-weight: bold; box-shadow: 2px 2px 0px rgba(0,0,0,0.2); transition: 0.1s; }
        .word-chip:hover { transform: translateY(-2px); box-shadow: 2px 4px 0px rgba(0,0,0,0.2); }
        .chip-pre { background-color: #bbdefb; border-color: #1976d2; color: #0d47a1; } 
        .chip-suf { background-color: #e1bee7; border-color: #8e24aa; color: #4a148c; } 
        .craft-row { display: flex; width: 95%; align-items: center; gap: 10px; margin-bottom: 8px; background: #fff; padding: 8px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .craft-icon { font-size: 20px; width: 30px; text-align: center; }
        .craft-desc { flex: 1; text-align: left; font-size: 12px; color: #555; }
        .craft-title { font-weight: bold; color: #2c3e50; display: block; font-size: 14px; }
        .craft-cost { font-size: 11px; font-weight: bold; color: #e67e22; background: #fff3e0; padding: 2px 6px; border-radius: 4px; }
        .craft-btn { background: #27ae60; color: white; border: none; border-bottom: 3px solid #1e8449; border-radius: 4px; padding: 8px 15px; font-size: 12px; font-weight: bold; cursor: pointer; min-width: 80px; text-align: center; transition: 0.1s; }
        .craft-btn:active { transform: translateY(2px); border-bottom: 0px; margin-top: 3px; }
        .artifact-item { width: 90%; background: #5d4037; color: #ffecb3; border: 2px solid #3e2723; padding: 12px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .artifact-word { font-family: 'Courier New', monospace; font-weight: bold; font-size: 18px; letter-spacing: 2px; text-shadow: 1px 1px 0 #000; }
        .salvage-btn { background: #d35400; border-color: #a04000; }
        .break-anim { animation: shake 0.4s; background: #c0392b !important; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        #resource-bar { display: flex; justify-content: space-around; background: #3e2723; color: white; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 13px; font-weight: bold; border: 1px solid #5d4037; }
        #forge-msg { min-height: 50px; height: auto; font-weight: bold; color: #2c3e50; font-size: 13px; border: 2px solid #8d6e63; background: #fff8e1; padding: 10px; margin-bottom: 10px; line-height: 1.4; display: flex; flex-direction: column; justify-content: center; align-items: center; }

        /* DIALOGUE & HUD */
        #dialogue-box { position: absolute; bottom: 20px; left: 5%; width: 90%; background: #fff; border: 4px solid #3e2723; padding: 15px; border-radius: 8px; display: none; font-family: 'Courier New', monospace; font-size: 16px; line-height: 1.5; box-shadow: 0 5px 15px rgba(0,0,0,0.5); pointer-events: auto; z-index: 20; }
        .npc-name { color: #d35400; font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .next-btn { float: right; background: #3e2723; color: white; border: none; padding: 5px 10px; cursor: pointer; font-family: inherit; margin-top: 10px; }

        #mobile-controls { position: absolute; bottom: 10px; left: 0; width: 100%; height: 160px; pointer-events: none; z-index: 5; display: none; }
        .control-group { pointer-events: auto; position: absolute; bottom: 10px; }
        .dpad { left: 20px; width: 120px; height: 120px; position: relative; }
        .actions { right: 20px; display: flex; gap: 15px; align-items: flex-end; }
        .touch-btn { background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 50%; backdrop-filter: blur(4px); color: white; font-size: 24px; display: flex; justify-content: center; align-items: center; user-select: none; touch-action: none; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .touch-btn:active { background: rgba(255, 255, 255, 0.5); transform: scale(0.95); }
        .d-btn { position: absolute; width: 40px; height: 40px; }
        .d-up { top: 0; left: 40px; } .d-down { bottom: 0; left: 40px; } .d-left { top: 40px; left: 0; } .d-right { top: 40px; right: 0; }
        .act-btn { width: 60px; height: 60px; font-size: 28px; } .act-sm { width: 45px; height: 45px; font-size: 20px; margin-bottom: 20px; }

        .toggle-btn { background: #ccc; border-radius: 20px; width: 40px; height: 20px; position: relative; cursor: pointer; transition: 0.3s; display:inline-block; vertical-align:middle; margin-left:10px; }
        .toggle-btn.on { background: #27ae60; }
        .toggle-btn.on::after { left: 22px; }
        .toggle-btn::after { content:''; position: absolute; left: 2px; top: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: 0.3s; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px; color: #d35400; margin-top:0; }
        .save-btn { background: #8e44ad; color: white; border: none; padding: 10px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="game-frame">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="loading" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white; font-family:monospace;">Forging World...</div>

        <div id="dialogue-box">
            <span class="npc-name">Elder Bark</span>
            <div id="dialogue-text">Hello traveler!</div>
            <button class="next-btn" onclick="advanceDialogue()">Next ‚ñ∂</button>
        </div>

        <div id="mobile-controls">
            <div class="control-group dpad">
                <div class="touch-btn d-btn d-up" ontouchstart="simKey('ArrowUp', true)" ontouchend="simKey('ArrowUp', false)">‚¨ÜÔ∏è</div>
                <div class="touch-btn d-btn d-down" ontouchstart="simKey('ArrowDown', true)" ontouchend="simKey('ArrowDown', false)">‚¨áÔ∏è</div>
                <div class="touch-btn d-btn d-left" ontouchstart="simKey('ArrowLeft', true)" ontouchend="simKey('ArrowLeft', false)">‚¨ÖÔ∏è</div>
                <div class="touch-btn d-btn d-right" ontouchstart="simKey('ArrowRight', true)" ontouchend="simKey('ArrowRight', false)">‚û°Ô∏è</div>
            </div>
            <div class="control-group actions">
                <div class="touch-btn act-btn act-sm" ontouchstart="setGameState('inventory')" style="background:rgba(200,100,0,0.4)">üéí</div>
                <div class="touch-btn act-btn act-sm" ontouchstart="interact()" style="background:rgba(100,200,255,0.4)">üí¨</div> <div class="touch-btn act-btn" ontouchstart="shootArrow()" style="background:rgba(0,100,200,0.4)">üèπ</div>
                <div class="touch-btn act-btn" ontouchstart="action()" style="background:rgba(200,50,50,0.4)">‚õèÔ∏è</div>
            </div>
        </div>

        <div id="overlay-layer">
            <div id="screen-start" class="popup active">
                <h1 style="color:#c0392b; margin-top:0; font-size: 28px;">WordCraft</h1>
                <h3 style="color:#555; margin-top:0;">Legends of Literacy</h3>
                <div style="text-align: left; background: #fff3e0; padding: 15px; border-radius: 4px; font-size: 14px; margin-bottom:15px; border:1px solid #ffe0b2;">
                    <p><b>‚ú® Quest Update:</b></p>
                    <ul style="padding-left:20px; margin:5px 0;">
                        <li><b>NPC Teachers:</b> Find <b>Elder Bark</b> (Surface) and <b>Rusty</b> (Caves).</li>
                        <li><b>Quests:</b> Solve their word puzzles to unlock the <b>Map</b> and <b>Super Drill</b>!</li>
                        <li><b>Save Game:</b> Use the inventory menu to save your progress.</li>
                    </ul>
                    <div style="margin-top:10px; font-weight:bold; cursor:pointer;" onclick="toggleMobileControls()">
                        üì± Enable Mobile Controls: <div class="toggle-btn" id="mob-toggle"></div>
                    </div>
                </div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button id="btn-continue" onclick="loadGame()" style="display:none; background:#27ae60; color:white; border:none; padding:12px 25px; font-size:18px; border-radius:5px; cursor:pointer; font-weight:bold;">Resume Game</button>
                    <button onclick="initAudio(); setGameState('playing')" style="background:#d35400; color:white; border:none; padding:12px 25px; font-size:18px; border-radius:5px; cursor:pointer; font-weight:bold;">New Adventure</button>
                </div>
            </div>
            
            <div id="screen-death" class="popup">
                <h1 style="color:red;">Scrambled!</h1>
                <p>The Letter Bugs scrambled your words.</p>
                <button onclick="location.reload()" style="background:#c0392b; color:white; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">Respawn</button>
            </div>

            <div id="screen-inv" class="popup">
                <div class="forge-tabs">
                    <div class="tab active" onclick="switchTab('word')">Word Forge</div>
                    <div class="tab" onclick="switchTab('salvage')">Salvage Station</div>
                    <div class="tab" onclick="switchTab('craft')">Tool Bench</div>
                </div>
                
                <div id="resource-bar">
                    <span>üíé: <span id="res-frag">0</span></span>
                    <span>üü´: <span id="res-dirt">0</span></span>
                    <span>üåë: <span id="res-stone">0</span></span>
                    <span>ü™µ: <span id="res-wood">0</span></span>
                </div>

                <div id="tab-word" style="display:flex; flex-direction:column; height:100%;">
                    <div class="crafting-grid">
                        <div id="slot-pre" class="craft-slot" onclick="clearSlot('pre')">[Pre]</div> +
                        <div id="slot-root" class="craft-slot" onclick="clearSlot('root')">[ROOT]</div> +
                        <div id="slot-suf" class="craft-slot" onclick="clearSlot('suf')">[Suf]</div>
                        <button onclick="forgeWord()" style="height:60px; background:#27ae60; border:none; color:white; border-radius:4px; font-weight:bold; cursor:pointer;">üî® FORGE</button>
                    </div>
                    <div id="forge-msg">Drag items here to forge!<br>Words earn you üíé Gems.</div>
                    <div style="display:flex; gap:10px; text-align:left; margin-top:10px; flex:1; overflow:hidden;">
                        <div style="flex:1; display:flex; flex-direction:column;">
                            <small style="background:#a1887f; color:white; padding:2px 5px; border-radius:3px;">ROOTS</small>
                            <div id="list-roots" class="inv-grid"></div>
                        </div>
                        <div style="flex:1; display:flex; flex-direction:column;">
                            <small style="background:#90caf9; color:#0d47a1; padding:2px 5px; border-radius:3px;">AFFIXES</small>
                            <div id="list-affixes" class="inv-grid"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-salvage" style="display:none; flex-direction:column; height:100%;">
                    <div style="text-align:center; padding:10px; background:rgba(255,255,255,0.6); border-radius:4px; margin-bottom:10px;">
                        <h3 style="margin:0; color:#5d4037;">ü™ö Salvage Station</h3>
                        <p style="font-size:12px; margin:5px 0;">Break down Artifacts to find word parts!</p>
                    </div>
                    <div id="list-artifacts" class="inv-grid" style="flex-direction:column; justify-content: flex-start; align-items:center;"></div>
                </div>

                <div id="tab-craft" style="display:none; flex-direction:column; height:100%;">
                    <div class="inv-grid" style="flex-direction:column; justify-content: flex-start; padding-bottom:50px;">
                        <div class="craft-row" style="background:#e8f5e9; border:1px solid #a5d6a7;">
                            <div class="craft-icon">üíä</div><div class="craft-desc"><span class="craft-title">Mud Poultice</span><span class="craft-cost">Cost: 3 Dirt</span></div>
                            <button class="craft-btn" onclick="craft('heal_mud')">Craft</button>
                        </div>
                         <div class="craft-row" style="background:#fff3e0; border:1px solid #ffcc80;">
                            <div class="craft-icon">üî•</div><div class="craft-desc"><span class="craft-title">Campfire</span><span class="craft-cost">Cost: 3 Wood</span></div>
                            <button class="craft-btn" onclick="craft('time_wood')">Craft</button>
                        </div>
                        <hr style="width:100%; border:1px solid #ddd; margin: 10px 0;">
                        <div style="font-size:10px; color:#999; text-transform:uppercase; font-weight:bold; margin-bottom:5px;">Building Blocks (Click Name to Equip)</div>
                        <div class="craft-row"><div class="craft-icon">üß±</div><div class="craft-desc" onclick="setActiveBlock(9, 'Dirt Wall')" style="cursor:pointer;"><span class="craft-title">Dirt Wall x5</span><span class="craft-cost">1 Dirt</span></div><button class="craft-btn" onclick="craft('wall')">Make</button></div>
                        <div class="craft-row"><div class="craft-icon">ü™µ</div><div class="craft-desc" onclick="setActiveBlock(4, 'Plank')" style="cursor:pointer;"><span class="craft-title">Planks x5</span><span class="craft-cost">2 Wood</span></div><button class="craft-btn" onclick="craft('wood')">Make</button></div>
                        <div class="craft-row"><div class="craft-icon">üèπ</div><div class="craft-desc"><span class="craft-title">Arrows x10</span><span class="craft-cost">2 Gem + 1 Wood</span></div><button class="craft-btn" onclick="craft('arrows')">Make</button></div>
                         <div class="craft-row"><div class="craft-icon">‚úíÔ∏è</div><div class="craft-desc"><span class="craft-title">Golden Quill</span><span class="craft-cost">10 Gem</span></div><button class="craft-btn" onclick="craft('quill')">Buy</button></div>
                    </div>
                </div>
                
                <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
                     <button class="save-btn" onclick="saveGame()">üíæ Save Game</button>
                     <button onclick="setGameState('playing')" style="background:#5d4037; color:white; border:none; padding:10px; font-weight:bold; cursor:pointer; border-radius:4px;">Close Book</button>
                </div>
            </div>
        </div>
    </div>
    <div style="color:#aaa; font-size:12px; margin-top:5px; text-align:center;">Keys: Arrows to Move | Space/T to Interact | F to Shoot | B to Build | I for Inventory</div>

<script>
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
    const sfx = { playTone: (f,t,d,v=0.1) => { if(!audioCtx) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=t; o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+d); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d); }, jump:()=>sfx.playTone(300,'sine',0.2), mine:()=>sfx.playTone(100,'square',0.1), shoot:()=>sfx.playTone(600,'sawtooth',0.1), build:()=>sfx.playTone(200,'triangle',0.1), collect:()=>sfx.playTone(800,'sine',0.3), hit:()=>sfx.playTone(150,'sawtooth',0.3), craft:()=>sfx.playTone(500,'square',0.5), quest:()=>sfx.playTone(600,'triangle',0.6) };

    const assets = { tiles: new Image(), chars: new Image(), ui: new Image() };
    const processedAssets = { tiles: null, chars: null, ui: null };
    let loadedCount=0, useFallbackAssets=false;
    function onAssetLoad() { loadedCount++; if(loadedCount===3) processAssets(); }
    function onAssetError() { console.warn("Using fallback assets."); useFallbackAssets=true; loadedCount++; if(loadedCount===3) processAssets(); }
    function removeWhite(img) { const c=document.createElement('canvas'); const x=c.getContext('2d'); c.width=img.width; c.height=img.height; x.drawImage(img,0,0); const d=x.getImageData(0,0,c.width,c.height); for(let i=0;i<d.data.length;i+=4) { if(d.data[i]>240&&d.data[i+1]>240&&d.data[i+2]>240) d.data[i+3]=0; } x.putImageData(d,0,0); return c; }
    function processAssets() { if(!useFallbackAssets) { processedAssets.tiles=removeWhite(assets.tiles); processedAssets.chars=removeWhite(assets.chars); processedAssets.ui=removeWhite(assets.ui); } document.getElementById('loading').style.display='none'; if(localStorage.getItem('wordcraft_save')) document.getElementById('btn-continue').style.display='inline-block'; initGame(); }
    assets.tiles.src='assets/tiles.png'; assets.tiles.onload=onAssetLoad; assets.tiles.onerror=onAssetError;
    assets.chars.src='assets/chars.png'; assets.chars.onload=onAssetLoad; assets.chars.onerror=onAssetError;
    assets.ui.src='assets/ui.png'; assets.ui.onload=onAssetLoad; assets.ui.onerror=onAssetError;

    const TILE_SIZE=40, COLS=600, ROWS=150, CANVAS_W=800, CANVAS_H=600;
    const canvas=document.getElementById('gameCanvas'); const ctx=canvas.getContext('2d');
    canvas.width=CANVAS_W; canvas.height=CANVAS_H;
    const DAY_LENGTH=3600, NIGHT_START=1800;
    let gameTick=0, camera={x:0,y:0}, keys={}, mouse={x:0,y:0};

    const LAYER_ROOTS={1:["play","help","walk","look"], 2:["happy","cycle","form","port"], 3:["struct","ject","rupt","phon"]};
    const LAYER_AFFIXES={1:[{val:"s",type:"suf"},{val:"ed",type:"suf"},{val:"ing",type:"suf"}], 2:[{val:"un",type:"pre"},{val:"re",type:"pre"},{val:"ly",type:"suf"}], 3:[{val:"sub",type:"pre"},{val:"tion",type:"suf"},{val:"ment",type:"suf"}]};
    
    // --- NPC & QUEST DATA ---
    const NPCS = [
        { id: "bark", name: "Elder Bark", x: 25, y: 10, spriteRow: 1, intro: ["Greetings, little one.", "My roots are weak.", "Can you forge REPLANT?"], questId: "bark", questWord: "replant", complete: ["Ah! The forest awakens!", "Take this Map."] },
        { id: "rusty", name: "Rusty", x: 40, y: 55, spriteRow: 2, intro: ["Bzzz... Systems offline.", "I need to rebuild.", "Forge RECONSTRUCT?"], questId: "rusty", questWord: "reconstruct", complete: ["System Online.", "Take this Drill!"] }
    ];
    
    const ARTIFACTS = [
        { name: "Mossy Spade", word: "REPLANTING", parts: [{t:'pre',v:'re'}, {t:'root',v:'plant'}, {t:'suf',v:'ing'}], desc: "Old tool." },
        { name: "Broken Gear", word: "RECONSTRUCTION", parts: [{t:'pre',v:'re'}, {t:'root',v:'struct'}, {t:'suf',v:'tion'}], desc: "Rusty part." },
        { name: "Stone Tablet", word: "UNCOVERED", parts: [{t:'pre',v:'un'}, {t:'root',v:'cover'}, {t:'suf',v:'ed'}], desc: "Ancient text." }
    ];
    
    let state='start', grid=[], enemies=[], particles=[], projectiles=[], animTick=0;
    let player={ x:20, y:10, hp:3, maxHp:3, fragments:0, resources:{dirt:0,sand:0,stone:0,wood:0,obsidian:0}, roots:[], affixes:[], artifacts:[], hasQuill:false, invinc:0, facingLeft:false, blocks:{9:5,4:0,5:0,11:0}, arrows:0, activeBlock:9, 
    quests:{bark:0, rusty:0}, unlocks:{map:false, drill:false} }; // 0=None, 1=Active, 2=Done
    let forge={pre:null,root:null,suf:null};
    let currentDialogue = null;

    function initGame() {
        grid=[];
        for(let r=0; r<ROWS; r++){
            let row=[];
            for(let c=0; c<COLS; c++){
                let s = 10 + Math.floor(Math.sin(c*0.05)*5);
                let isCave = (r>s+8) && (Math.random()<0.12);
                if(r<s) row.push(0); else if(isCave) row.push(0); else if(r<s+5) row.push(1); else if(r<s+15) row.push(12); else if(r<s+60) row.push(2); else row.push(3);
            }
            grid.push(row);
        }
        for(let r=20; r<ROWS-5; r++) for(let c=0; c<COLS; c++) if(grid[r][c]===0 && Math.random()<0.02) enemies.push({x:c, y:r, type:Math.random()>.5?'bat':'slime', hp:2, speed:15, stun:0});
        
        let gy=0; while(gy<ROWS && grid[gy][20]===0) gy++; player.y=gy-1;
        
        // FIX: Ensure NPCs are grounded correctly
        NPCS.forEach(n => {
            // Calculate Surface Height for Bark if he's on top
            if(n.id === 'bark') {
                let s = 10 + Math.floor(Math.sin(n.x*0.05)*5);
                n.y = s - 1; // Stand on top of the grass
            }
            // Ensure Rusty has a floor
            if(n.id === 'rusty') {
                // Clear his body space
                grid[n.y][n.x] = 0; 
                grid[n.y-1][n.x] = 0;
                // Build a floor underneath him
                if(grid[n.y+1][n.x] === 0) grid[n.y+1][n.x] = 5; // Stone Brick
            }
        });
        requestAnimationFrame(loop);
    }

    function loop() { if(state==='playing') update(); draw(); requestAnimationFrame(loop); }

    function update() {
        animTick++; gameTick++; if(player.invinc>0) player.invinc--;
        let tX=(player.x*TILE_SIZE)-(CANVAS_W/2), tY=(player.y*TILE_SIZE)-(CANVAS_H/2);
        camera.x=Math.max(0,Math.min(tX,(COLS*TILE_SIZE)-CANVAS_W)); camera.y=Math.max(0,Math.min(tY,(ROWS*TILE_SIZE)-CANVAS_H));

        enemies.forEach((en,i)=>{
            if(en.stun>0) { en.stun--; return; }
            if(Math.abs(en.x-player.x)<30 && Math.abs(en.y-player.y)<20) {
                if(animTick%en.speed===0) {
                    let nx=en.x, ny=en.y;
                    if(en.x<player.x) nx++; else if(en.x>player.x) nx--; else if(en.y<player.y) ny++; else if(en.y>player.y) ny--;
                    if(grid[ny][nx]===0) { en.x=nx; en.y=ny; }
                }
                if(en.x===player.x && en.y===player.y) hurtPlayer();
            }
        });
        
        for(let i=projectiles.length-1; i>=0; i--) {
            let p=projectiles[i]; p.x+=p.vx; p.y+=p.vy;
            let gx=Math.round(p.x), gy=Math.round(p.y), hit=false;
            enemies.forEach((en,ei)=>{ if(Math.round(en.x)===gx && Math.round(en.y)===gy) { en.hp--; hit=true; sfx.hit(); if(en.hp<=0) {enemies.splice(ei,1); player.fragments+=3;} } });
            if(gx<0||gx>=COLS||gy<0||gy>=ROWS||(grid[gy][gx]!==0)||hit) projectiles.splice(i,1);
        }
        for(let i=particles.length-1; i>=0; i--) { particles[i].life--; particles[i].y-=0.5; if(particles[i].life<=0) particles.splice(i,1); }
    }

    document.addEventListener('keydown', e=>{
        if(e.key===' ') e.preventDefault();
        keys[e.key]=true;
        if(state!=='playing') return;
        let dx=0, dy=0;
        if(e.key==='ArrowLeft') { dx=-1; player.facingLeft=true; } if(e.key==='ArrowRight') { dx=1; player.facingLeft=false; }
        if(e.key==='ArrowUp') dy=-1; if(e.key==='ArrowDown') dy=1;
        if(dx!==0||dy!==0) { let nx=player.x+dx, ny=player.y+dy; if(nx>=0&&nx<COLS&&ny>=0&&ny<ROWS&&grid[ny][nx]===0) { player.x=nx; player.y=ny; } }
        if(e.key===' ') interact();
        if(e.key==='f'||e.key==='F') shootArrow();
        if(e.key==='i'||e.key==='I') setGameState('inventory');
        if(e.key==='b'||e.key==='B') placeBlock();
        if(e.key==='t'||e.key==='T') interact();
        if(e.key==='m'||e.key==='M') toggleMap();
    });
    document.addEventListener('keyup', e=>{ keys[e.key]=false; });

    // FIX: Better Toggle Logic
    function toggleMobileControls() {
        let el = document.getElementById('mobile-controls');
        // Check computed style or explicit inline
        let isHidden = window.getComputedStyle(el).display === 'none';
        
        if(isHidden) {
            el.style.display = 'block';
            document.getElementById('mob-toggle').classList.add('on');
        } else {
            el.style.display = 'none';
            document.getElementById('mob-toggle').classList.remove('on');
        }
    }

    function interact() {
        // 1. Check for NPCs
        let talked = false;
        NPCS.forEach(n => {
            if(Math.abs(player.x - n.x) < 3 && Math.abs(player.y - n.y) < 3) {
                startDialogue(n); talked = true;
            }
        });
        if(talked) return;

        // 2. Action (Mine/Fight)
        action();
    }

    function startDialogue(npc) {
        let box = document.getElementById('dialogue-box');
        let text = document.getElementById('dialogue-text');
        box.style.display = 'block';
        document.querySelector('.npc-name').innerText = npc.name;
        
        let qState = player.quests[npc.id];
        let lines = [];
        
        if(qState === 2) { // Done
            lines = ["Thanks again!", "The world is healing."];
        } else if(qState === 1) { // Active
            lines = [`I am still waiting for ${npc.questWord.toUpperCase()}.`, "Check your Artifacts for parts."];
        } else { // New
            lines = npc.intro;
            player.quests[npc.id] = 1; // Start Quest
            alert("Quest Started! Find items to forge " + npc.questWord.toUpperCase());
            // Force give first artifact hint?
        }
        
        currentDialogue = { lines: lines, index: 0 };
        text.innerText = lines[0];
    }
    
    function advanceDialogue() {
        if(!currentDialogue) return;
        currentDialogue.index++;
        if(currentDialogue.index < currentDialogue.lines.length) {
            document.getElementById('dialogue-text').innerText = currentDialogue.lines[currentDialogue.index];
        } else {
            document.getElementById('dialogue-box').style.display = 'none';
            currentDialogue = null;
        }
    }

    function action() {
        let tx=player.x, ty=player.y;
        if(keys['ArrowUp']) ty--; else if(keys['ArrowDown']) ty++; else if(keys['ArrowLeft']) tx--; else if(keys['ArrowRight']) tx++; else { tx+=(player.facingLeft?-1:1); if(grid[ty][tx]===0) ty++; }
        if(tx>=0&&tx<COLS&&ty>=0&&ty<ROWS) {
            let t=grid[ty][tx];
            if(t>0) {
                grid[ty][tx]=0; sfx.mine(); addPart(tx,ty,"‚ú®");
                // Resource Gain (Drill doubles it)
                let gain = player.unlocks.drill ? 2 : 1;
                if(t===1) player.resources.dirt+=gain; else if(t===12) player.resources.sand+=gain; else if(t===2) player.resources.stone+=gain; else if(t===3) player.resources.obsidian+=gain;
                
                // QUEST LOOT LOGIC
                // If Bark Quest Active, high chance for Seeds
                if(player.quests.bark === 1 && Math.random() < 0.25) {
                    player.artifacts.push({ name: "Ancient Seed", word: "REPLANT", parts: [{t:'pre',v:'re'}, {t:'root',v:'plant'}], desc: "Quest Item" });
                    addPart(player.x, player.y-1, "üå±", "green"); sfx.collect();
                }
                // If Rusty Quest Active, high chance for Gears
                else if(player.quests.rusty === 1 && Math.random() < 0.25) {
                     player.artifacts.push({ name: "Rusted Gear", word: "RECONSTRUCT", parts: [{t:'pre',v:'re'}, {t:'root',v:'struct'}, {t:'suf',v:'tion'}], desc: "Quest Item" });
                     addPart(player.x, player.y-1, "‚öôÔ∏è", "gray"); sfx.collect();
                }
                // Normal Loot
                else if(Math.random()>0.6) {
                    let r=Math.random();
                    if(r<0.15) { let a=ARTIFACTS[Math.floor(Math.random()*ARTIFACTS.length)]; player.artifacts.push(a); addPart(player.x,player.y-1,"üéÅ","gold"); sfx.collect(); }
                    else {
                         let l=LAYER_ROOTS[t]||["root"]; player.roots.push({word:l[Math.floor(Math.random()*l.length)],type:t}); addPart(player.x,player.y-1,"üìú");
                    }
                }
            }
        }
    }
    
    function placeBlock() { let id=player.activeBlock; if(player.blocks[id]>0 && grid[player.y][player.x]===0) { grid[player.y][player.x]=id; player.blocks[id]--; sfx.build(); } }
    function shootArrow() { if(player.arrows>0) { player.arrows--; projectiles.push({x:player.x,y:player.y,vx:(player.facingLeft?-1:1),vy:0}); sfx.shoot(); } }
    function addPart(x,y,c,cl="white") { particles.push({x:x,y:y,char:c,color:cl,life:30}); }
    function hurtPlayer() { if(player.invinc>0) return; player.hp--; player.invinc=30; sfx.hit(); if(player.hp<=0) setGameState('death'); }

    function draw() {
        let tod=gameTick%DAY_LENGTH; let cp=Math.sin((tod/DAY_LENGTH)*Math.PI);
        let r=Math.floor(135*cp+20*(1-cp)), g=Math.floor(206*cp+20*(1-cp)), b=Math.floor(235*cp+60*(1-cp));
        ctx.fillStyle=`rgb(${r},${g},${b})`; ctx.fillRect(0,0,CANVAS_W,CANVAS_H);

        let tW=useFallbackAssets?TILE_SIZE:processedAssets.tiles.width; 
        let tH=useFallbackAssets?TILE_SIZE:processedAssets.tiles.height/5;
        let cX=Math.floor(camera.x/TILE_SIZE), cY=Math.floor(camera.y/TILE_SIZE);
        let eX=cX+(CANVAS_W/TILE_SIZE)+1, eY=cY+(CANVAS_H/TILE_SIZE)+1;

        ctx.save(); ctx.translate(-camera.x, -camera.y);

        for(let r=cY; r<=eY; r++){
            for(let c=cX; c<=eX; c++){
                if(r>=0 && r<ROWS && c>=0 && c<COLS) {
                    let t=grid[r][c];
                    // Map Overlay Effect
                    if(player.unlocks.map && t>0) ctx.globalAlpha = 0.5; 
                    
                    if(t>0) {
                         if(useFallbackAssets) { ctx.fillStyle="brown"; ctx.fillRect(c*TILE_SIZE,r*TILE_SIZE,TILE_SIZE,TILE_SIZE); }
                         else {
                             let tidx = (t<=3) ? t-1 : (t===12?0:(t===9?3:0));
                             ctx.drawImage(processedAssets.tiles, tW*0.4, (tidx*tH)+tH*0.2, tW*0.2, tH*0.6, c*TILE_SIZE, r*TILE_SIZE, TILE_SIZE+1, TILE_SIZE+1);
                         }
                    }
                    ctx.globalAlpha = 1.0;
                }
            }
        }
        
        // Draw NPCs
        NPCS.forEach(n => {
            // FIX: Draw text baseline top to match alignment
            ctx.textBaseline = "top";
            ctx.font = "30px Arial";
            ctx.fillText(n.id==='bark'?"üå≥":"ü§ñ", n.x*TILE_SIZE, n.y*TILE_SIZE);
            if(Math.abs(player.x - n.x) < 3 && Math.abs(player.y - n.y) < 3) {
                 ctx.font = "14px Arial"; ctx.fillStyle = "white";
                 ctx.fillText("PRESS T", n.x*TILE_SIZE-10, n.y*TILE_SIZE-20);
            }
        });
        ctx.textBaseline = "alphabetic"; // Reset

        // Player & Enemies
        if(!useFallbackAssets) {
            let cW=processedAssets.chars.width/3, cH=processedAssets.chars.height/3;
            ctx.save(); if(player.facingLeft) { ctx.translate((player.x*TILE_SIZE)+TILE_SIZE,player.y*TILE_SIZE); ctx.scale(-1,1); ctx.drawImage(processedAssets.chars, (Math.floor(animTick/20)%2)*cW, 0, cW, cH, 0, 0, TILE_SIZE, TILE_SIZE); }
            else ctx.drawImage(processedAssets.chars, (Math.floor(animTick/20)%2)*cW, 0, cW, cH, player.x*TILE_SIZE, player.y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
            ctx.restore();
            
            enemies.forEach(en=>{
                ctx.drawImage(processedAssets.chars, (Math.floor(animTick/10)%3)*cW, (en.type==='bat'?1:2)*cH, cW, cH, en.x*TILE_SIZE, en.y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
            });
        }
        
        ctx.fillStyle="yellow"; projectiles.forEach(p=>ctx.fillRect(p.x*TILE_SIZE,p.y*TILE_SIZE,5,5));
        ctx.font="20px Arial"; particles.forEach(p=>{ctx.fillStyle=p.color; ctx.fillText(p.char,p.x*TILE_SIZE,p.y*TILE_SIZE)});
        ctx.restore();

        // HUD
        ctx.fillStyle="white"; ctx.font="bold 20px Verdana"; ctx.fillText(player.fragments, 100, 30);
        ctx.font="14px Verdana"; ctx.fillText(player.unlocks.drill?"Drill Active!":"Pickaxe", 10, 50);
        ctx.fillText(player.unlocks.map?"Map Active":"No Map", 10, 70);
    }
    
    function setGameState(s) { state=s; document.querySelectorAll('.popup').forEach(e=>e.classList.remove('active')); if(s==='start')document.getElementById('screen-start').classList.add('active'); if(s==='inventory'){document.getElementById('screen-inv').classList.add('active');renderInventory();} if(s==='playing') initAudio(); }
    function switchTab(t) { document.getElementById('tab-word').style.display=t==='word'?'flex':'none'; document.getElementById('tab-craft').style.display=t==='craft'?'flex':'none'; document.getElementById('tab-salvage').style.display=t==='salvage'?'flex':'none'; if(t==='salvage')renderSalvage(); document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')); event.target.classList.add('active'); }
    function renderSalvage() { 
        let d=document.getElementById('list-artifacts'); d.innerHTML=""; 
        if(player.artifacts.length===0) d.innerHTML="<div style='padding:20px'>Go mine!</div>";
        player.artifacts.forEach((a,i)=>{
            d.innerHTML+=`<div class='artifact-item'><div><div class='artifact-word'>${a.word}</div><div style='font-size:10px;color:#f1c40f'>${a.desc}</div></div><button class='salvage-btn' onclick='salvageItem(${i},this)'>BREAK</button></div>`;
        });
    }
    function salvageItem(i,btn) {
        if(!player.artifacts[i]) return;
        btn.parentElement.classList.add('break-anim'); sfx.mine();
        setTimeout(()=>{
            let it=player.artifacts[i]; it.parts.forEach(p=>{ if(p.t==='root')player.roots.push({word:p.v,type:1}); else player.affixes.push({val:p.v,type:p.t}); });
            player.artifacts.splice(i,1); player.fragments+=5;
            renderSalvage(); renderInventory();
        },400);
    }
    
    async function forgeWord() {
        if(!forge.root) return;
        let m=document.getElementById('forge-msg'); m.innerHTML="Checking..."; sfx.craft();
        let w = ((forge.pre||"") + forge.root + (forge.suf||"")).toLowerCase();
        
        // --- QUEST CHECK ---
        NPCS.forEach(n => {
            if(player.quests[n.id] === 1 && w === n.questWord) {
                player.quests[n.id] = 2; // Complete
                if(n.id === 'bark') player.unlocks.map = true;
                if(n.id === 'rusty') player.unlocks.drill = true;
                alert(`QUEST COMPLETE: ${n.name} is happy! Reward Unlocked!`);
                sfx.quest();
            }
        });
        
        m.innerHTML = `<span style="color:green">‚ú® ${w.toUpperCase()}</span>`;
        player.fragments+=10; sfx.collect();
        // Clear slots
        forge={pre:null,root:null,suf:null}; document.getElementById('slot-pre').innerText="[Pre]"; document.getElementById('slot-root').innerText="[Root]"; document.getElementById('slot-suf').innerText="[Suf]";
        renderInventory();
    }

    function setSlot(t,v) { forge[t]=v; document.getElementById(`slot-${t}`).innerText=v; }
    function clearSlot(t) { forge[t]=null; document.getElementById(`slot-${t}`).innerText=`[${t}]`; }
    function setActiveBlock(id,n) { player.activeBlock=id; alert("Equipped: "+n); }
    function craft(i) {
        if(i==='heal_mud'&&player.resources.dirt>=3) { player.resources.dirt-=3; player.hp=3; alert("Healed!"); }
        else if(i==='wall'&&player.resources.dirt>=1) { player.resources.dirt--; player.blocks[9]+=5; }
        else if(i==='wood'&&player.resources.wood>=2) { player.resources.wood-=2; player.blocks[4]+=5; }
        updateInvCounts(); renderInventory();
    }
    function updateInvCounts() { document.getElementById('res-frag').innerText=player.fragments; }

    function saveGame() { localStorage.setItem('wordcraft_save', JSON.stringify({player, grid, enemies, gameTick})); alert("Saved!"); }
    function loadGame() { let d=JSON.parse(localStorage.getItem('wordcraft_save')); player=d.player; grid=d.grid; enemies=d.enemies; gameTick=d.gameTick; alert("Loaded!"); setGameState('playing'); }
    function toggleMap() { if(player.unlocks.map) alert("Map Active: You can see through walls!"); else alert("You need to help Elder Bark first."); }
    function simKey(k,s) { keys[k]=s; if(s) initAudio(); }
</script>
</body>
</html>
