<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WordCraft v3.92: Titans & Grammar</title>
    <style>
        :root { --bg-color: #2c3e50; --ui-border: #5d4037; --accent: #e67e22; }
        body { 
            background-color: var(--bg-color); color: #2c3e50; 
            font-family: 'Verdana', sans-serif; 
            font-size: 16px; 
            display: flex; flex-direction: column; align-items: center; margin: 0; padding: 0; height: 100vh; overflow: hidden; user-select: none; touch-action: none; 
        }
        
        #game-frame { 
            position: relative; border: 6px solid var(--ui-border); border-radius: 8px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.9); background: #000; 
            cursor: crosshair; width: 100%; max-width: 800px; height: auto; aspect-ratio: 4/3;
        }
        canvas { display: block; image-rendering: pixelated; width: 100%; height: 100%; }
        
        #overlay-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; align-items: center; justify-content: center; z-index: 10; }
        
        .popup { 
            pointer-events: auto; background: #fff; border: 4px solid var(--ui-border); 
            border-radius: 8px; text-align: center; max-width: 95%; max-height: 95%; 
            display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            padding: 0; overflow: hidden; 
            line-height: 1.6 !important; font-size: 16px; 
        }
        .popup.active { display: flex; flex-direction: column; animation: popIn 0.2s ease-out; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* START SCREEN */
        .start-box { padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        h1 { margin: 0; color: #c0392b; font-size: 42px; text-shadow: 2px 2px 0 #eee; line-height: 1.2; }
        h3 { margin: 0; color: #555; font-size: 20px; line-height: 1.2; }
        
        /* INVENTORY LAYOUT */
        #screen-inv, #screen-saves { width: 750px; height: 580px; background-image: url('assets/bg.png'); background-color: #f3e5f5; background-size: cover; color: #3e2723; }
        .inv-header { padding: 15px; background: rgba(255,255,255,0.95); border-bottom: 3px solid #5d4037; flex-shrink: 0; }
        .inv-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .inv-footer { padding: 15px; background: rgba(255,255,255,0.95); border-top: 3px solid #5d4037; flex-shrink: 0; display: flex; justify-content: center; gap: 20px; }

        .forge-tabs { display: flex; background: rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; }
        .tab { flex: 1; padding: 15px; cursor: pointer; font-weight: bold; background: rgba(255,255,255,0.5); border-right: 1px solid rgba(0,0,0,0.1); transition: 0.2s; font-size: 16px; }
        .tab.active { background: #fff; color: #d35400; box-shadow: inset 0 -3px 0 #d35400; }
        
        /* FORGE UI */
        .forge-assembly {
            display: flex; align-items: center; justify-content: center; gap: 5px;
            background: rgba(255,255,255,0.5); padding: 15px; border-radius: 12px;
            border: 2px solid #bcaaa4; min-height: 90px;
        }
        .forge-zone {
            display: flex; gap: 4px; align-items: center; min-width: 40px; justify-content: center;
            transition: 0.2s;
        }
        #zone-pre { justify-content: flex-end; }
        #zone-suf { justify-content: flex-start; }

        #zone-root { 
            transform: scale(1.1); margin: 0 10px; z-index: 2; 
            border: 3px dashed #5d4037; border-radius: 8px; width: 80px; height: 60px;
            display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.8);
            cursor: pointer; font-weight: bold; color: #8d6e63;
        }
        #zone-root.occupied { border-style: solid; background: #fff; color: #2e7d32; border-color: #2e7d32; }

        .mini-chip {
            padding: 4px 10px; border-radius: 15px; font-size: 14px; font-weight: bold; cursor: pointer;
            border: 1px solid rgba(0,0,0,0.2); box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }
        .mini-chip:hover { transform: scale(1.1); color: red; border-color: red; } 
        
        .inv-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; background: rgba(255,255,255,0.4); border-radius: 6px; padding: 15px; min-height: 120px; border: 1px solid rgba(0,0,0,0.1); }
        .inv-body::-webkit-scrollbar { width: 12px; }
        .inv-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .inv-body::-webkit-scrollbar-thumb { background: #8d6e63; border-radius: 6px; }

        .word-chip { 
            background: #fff; border: 2px solid #5d4037; padding: 8px 16px; border-radius: 25px; cursor: pointer; 
            font-size: 16px; font-weight: bold; box-shadow: 0 3px 0 rgba(0,0,0,0.2); 
        }
        .word-chip:active { transform: translateY(2px); box-shadow: none; }
        .chip-pre { background-color: #bbdefb; border-color: #1565c0; color: #0d47a1; } 
        .chip-root { background-color: #c8e6c9; border-color: #2e7d32; color: #1b5e20; }
        .chip-suf { background-color: #e1bee7; border-color: #7b1fa2; color: #4a148c; } 
        
        .craft-row { display: flex; width: 98%; align-items: center; gap: 15px; margin-bottom: 8px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #aaa; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .craft-icon { font-size: 28px; width: 50px; text-align: center; }
        .craft-desc { flex: 1; text-align: left; font-size: 15px; }
        .craft-title { font-weight: bold; color: #2c3e50; display: block; font-size: 17px; margin-bottom: 4px; }
        .craft-cost { font-size: 13px; font-weight: bold; color: #e67e22; background: #fff3e0; padding: 4px 8px; border-radius: 4px; border: 1px solid #ffe0b2; }
        .craft-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; font-size: 15px; font-weight: bold; cursor: pointer; border-radius: 5px; min-width: 80px; box-shadow: 0 3px 0 #1e8449; }
        .craft-btn:active { transform: translateY(2px); box-shadow: none; }
        
        .artifact-item { width: 95%; background: #5d4037; color: #ffecb3; border: 2px solid #3e2723; padding: 15px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .salvage-btn { background: #d35400; border:none; padding:10px 20px; color:white; border-radius:5px; cursor:pointer; font-weight:bold; box-shadow: 0 3px 0 #a04000; font-size: 14px; }
        .salvage-btn:active { transform: translateY(2px); box-shadow: none; }
        
        #resource-bar { display: flex; justify-content: center; gap: 20px; background: #3e2723; color: white; padding: 10px; border-radius: 6px; font-size: 16px; font-weight: bold; border: 2px solid #5d4037; }
        #forge-msg { 
            min-height: 80px; background: #fff8e1; border: 2px solid #d35400; margin: 15px 0; padding: 15px; 
            font-size: 16px; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            border-radius: 6px; color: #d35400; font-weight: normal; 
        }

        .morph-highlight { color: #e74c3c; font-weight: bold; text-decoration: underline; text-decoration-thickness: 2px; }
        .btn-disabled { background-color: #95a5a6 !important; cursor: not-allowed !important; box-shadow: none !important; }
        
        .save-slot-row { background: white; padding: 15px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #ccc; box-shadow: 0 2px 2px rgba(0,0,0,0.1); }
        .save-info { text-align: left; }
        .save-title { font-weight: bold; font-size: 18px; color: #2c3e50; }
        .save-meta { font-size: 12px; color: #7f8c8d; }
        .save-actions { display: flex; gap: 10px; }
        .btn-load { background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-del { background: #c0392b; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* DIALOGUE & HUD */
        #dialogue-box { position: absolute; bottom: 20px; left: 5%; width: 90%; background: #fff; border: 4px solid #3e2723; padding: 25px; border-radius: 12px; display: none; font-family: 'Courier New', monospace; font-size: 20px; line-height: 1.4; box-shadow: 0 10px 25px rgba(0,0,0,0.5); pointer-events: auto; z-index: 20; box-sizing: border-box; }
        .npc-name { color: #d35400; font-weight: bold; display: block; margin-bottom: 10px; text-transform: uppercase; font-size: 22px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .next-btn { float: right; background: #3e2723; color: white; border: none; padding: 10px 20px; cursor: pointer; margin-top: 15px; font-size: 18px; border-radius: 4px; }

        /* --- FIXED MOBILE CONTROLS --- */
        #mobile-controls { position: absolute; bottom: 10px; left: 0; width: 100%; height: 220px; pointer-events: none; z-index: 5; display: none; }
        .control-group { pointer-events: auto; position: absolute; bottom: 10px; }
        .dpad { left: 20px; width: 140px; height: 140px; position: relative; }
        /* Adjusted width to fit 5 buttons comfortably */
        .actions { right: 10px; width: 220px; height: 160px; position: absolute; bottom: 10px; pointer-events: auto; }
        
        .touch-btn { 
            background: rgba(255, 255, 255, 0.2); 
            border: 2px solid rgba(255, 255, 255, 0.5); 
            border-radius: 50%; 
            backdrop-filter: blur(4px); 
            color: white; font-size: 24px; 
            display: flex; justify-content: center; align-items: center; 
            user-select: none; -webkit-user-select: none; touch-action: none; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            position: absolute; /* Positioning them specifically */
        }
        .touch-btn:active { background: rgba(255, 255, 255, 0.5); transform: scale(0.95); }
        
        /* D-PAD Positioning */
        .d-btn { width: 50px; height: 50px; }
        .d-up { top: 0; left: 45px; } 
        .d-down { bottom: 0; left: 45px; } 
        .d-left { top: 45px; left: 0; } 
        .d-right { top: 45px; right: 0; }
        
        /* ACTION BUTTONS (Right Side) */
        /* Large Primary Actions */
        .act-big { width: 65px; height: 65px; font-size: 30px; }
        /* Smaller Utility Actions */
        .act-sm { width: 50px; height: 50px; font-size: 22px; }

        /* Position Grid for Right Side */
        /* Row 1 (Bottom) */
        #btn-shoot { bottom: 0; left: 0; background:rgba(0,100,200,0.4); }
        #btn-mine { bottom: 10px; left: 75px; background:rgba(200,50,50,0.4); } /* CENTER PIECE */
        #btn-talk { bottom: 20px; left: 150px; background:rgba(100,200,255,0.4); }

        /* Row 2 (Top) */
        #btn-inv { bottom: 80px; left: 20px; background:rgba(200,100,0,0.4); }
        #btn-build { bottom: 90px; left: 100px; background:rgba(46, 204, 113, 0.5); border-color: rgba(46, 204, 113, 0.8); }

        .toggle-btn { background: #ccc; border-radius: 20px; width: 50px; height: 26px; position: relative; cursor: pointer; transition: 0.3s; display:inline-block; vertical-align:middle; margin-left:10px; border: 1px solid #999; }
        .toggle-btn.on { background: #27ae60; border-color: #1e8449; }
        .toggle-btn.on::after { left: 26px; }
        .toggle-btn::after { content:''; position: absolute; left: 2px; top: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        
        .save-btn { background: #8e44ad; color: white; border: none; padding: 12px 24px; border-radius: 5px; font-weight: bold; cursor: pointer; box-shadow: 0 3px 0 #6c3483; font-size: 16px; }
        .save-btn:active { transform: translateY(3px); box-shadow: none; }
        .close-btn { background: #c0392b; color: white; border: none; padding: 12px 24px; border-radius: 5px; font-weight: bold; cursor: pointer; box-shadow: 0 3px 0 #922b21; font-size: 16px; }
        .close-btn:active { transform: translateY(3px); box-shadow: none; }
/* FOCUS SYSTEM CSS */
        #hud-layer { position: absolute; top: 10px; right: 10px; left: auto; z-index: 5; pointer-events: none; }
        .stat-bar-box { background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 6px; border: 2px solid #fff; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; width: 200px; }
        .bar-label { color: white; font-weight: bold; font-size: 14px; width: 50px; }
        .bar-track { flex: 1; height: 12px; background: #333; border-radius: 4px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.3s; }
        #focus-fill { background: linear-gradient(90deg, #3498db, #8e44ad); }
        
        .toast { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; pointer-events: none; opacity: 0; transition: 0.5s; z-index: 100; text-align: center; }
        .toast.show { opacity: 1; top: 100px; }
        .toast.warn { background: rgba(192, 57, 43, 0.9); border: 2px solid #e74c3c; }
        .toast.good { background: rgba(39, 174, 96, 0.9); border: 2px solid #2ecc71; }
    </style>
</head>
<body>
    <div id="game-frame">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="loading" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white; font-family:monospace;">Forging World...</div>
<div id="hud-layer">
            <div class="stat-bar-box">
                <div class="bar-label">FOCUS</div>
                <div class="bar-track"><div class="bar-fill" id="focus-fill" style="width:100%"></div></div>
            </div>
        </div>
        <div id="toast-msg" class="toast">Alert</div>

        <div id="dialogue-box">
            <span class="npc-name">NPC</span>
            <div id="dialogue-text">...</div>
            <button class="next-btn" onclick="advanceDialogue()">Next ‚ñ∂</button>
        </div>

        <div id="mobile-controls">
            <div class="control-group dpad">
                <div id="btn-up" class="touch-btn d-btn d-up" data-key="ArrowUp">‚¨ÜÔ∏è</div>
                <div id="btn-down" class="touch-btn d-btn d-down" data-key="ArrowDown">‚¨áÔ∏è</div>
                <div id="btn-left" class="touch-btn d-btn d-left" data-key="ArrowLeft">‚¨ÖÔ∏è</div>
                <div id="btn-right" class="touch-btn d-btn d-right" data-key="ArrowRight">‚û°Ô∏è</div>
            </div>
            
            <div class="actions">
                <div id="btn-shoot" class="touch-btn act-sm" data-key="f">üèπ</div>
                <div id="btn-mine" class="touch-btn act-big" data-key="action">‚õèÔ∏è</div>
                <div id="btn-talk" class="touch-btn act-sm" data-key=" ">üí¨</div>
                
                <div id="btn-inv" class="touch-btn act-sm" data-key="i">üéí</div>
                <div id="btn-build" class="touch-btn act-big" data-key="b">üî®</div>
            </div>
        </div>

        <div id="overlay-layer">
            <div id="screen-start" class="popup active">
                <div class="start-box">
                    <div>
                        <h1>WordCraft</h1>
                        <h3>The Morphology Engine</h3>
                    </div>
                    <div style="text-align: left; background: #fff3e0; padding: 20px; border-radius: 8px; font-size: 16px; border:2px solid #ffe0b2;">
                        <p><b>‚ú® Update v4: The Titans Update</b></p>
                        <ul style="padding-left:20px; margin:10px 0;">
                            <li><b>Focus</b> You now need craft words or the world will freeze</li>
			    <li><b>Focus meter</b> "Check your meter on the top</li>
                            <li><b>Respawn</b> Beware of monsters on respawn!</li>
			    <li><b>Expensive!</b> Prices went up!</li>
			    <li><b>New Tools</b> Can't dig without the right tool</li>
                        </ul>
                        <div style="margin-top:15px; font-weight:bold; cursor:pointer; display:flex; align-items:center;" onclick="toggleMobileControls()">
                            üì± Enable Mobile Controls: <div class="toggle-btn" id="mob-toggle"></div>
                        </div>
                    </div>

                    <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; border: 1px solid #c8e6c9; text-align:left; display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" id="chk-teacher" checked onchange="teacherMode = this.checked" style="width:20px; height:20px;">
                        <label for="chk-teacher" style="font-size:15px; font-weight:bold; color:#2e7d32; cursor:pointer;">
                            üë©‚Äçüè´ Teacher Mode (Show Spelling Rules)
                        </label>
                    </div>

                    <div style="display:flex; gap:15px; justify-content:center; margin-top:10px;">
                        <button onclick="toggleSaveMenu(true)" style="background:#2980b9; color:white; border:none; padding:15px 30px; font-size:18px; border-radius:6px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 0 #1f618d;">Load Game</button>
                        <button onclick="initAudio(); setGameState('playing')" style="background:#d35400; color:white; border:none; padding:15px 30px; font-size:18px; border-radius:6px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 0 #a04000;">New Game</button>
                    </div>
                </div>
            </div>
            
            <div id="screen-saves" class="popup">
                <div class="inv-header">
                    <h2 style="margin:0; color:#3e2723;">üíæ Save Manager</h2>
                </div>
                <div class="inv-body" id="save-list-container">
                    </div>
                <div class="inv-footer" style="flex-direction:column; gap:10px;">
                    <div id="save-input-area" style="display:none; width:100%; gap:10px; justify-content:center;">
                        <input type="text" id="save-name-input" placeholder="World Name (e.g. Class 2A)" style="padding:10px; font-size:16px; border-radius:4px; border:1px solid #aaa; flex:1;">
                        <button onclick="doSave()" style="background:#27ae60; color:white; border:none; padding:10px 20px; font-weight:bold; border-radius:4px; cursor:pointer;">Save</button>
                    </div>
                    <button class="close-btn" onclick="closeSaveMenu()">Cancel / Close</button>
                </div>
            </div>
            
            <div id="screen-death" class="popup" style="justify-content:center; padding: 30px;">
                <h1 style="color:red; margin-bottom:20px;">Scrambled!</h1>
                <p style="margin-bottom:20px;">The Letter Bugs got you.</p>
                <button onclick="respawnPlayer()" style="background:#c0392b; color:white; padding:12px 25px; border:none; border-radius:6px; cursor:pointer; font-size:16px;">Respawn</button>
            </div>

            <div id="screen-inv" class="popup">
                <div class="inv-header">
                    <div class="forge-tabs">
                        <div class="tab active" onclick="switchTab('word')">Word Forge</div>
                        <div class="tab" onclick="switchTab('salvage')">Salvage</div>
                        <div class="tab" onclick="switchTab('craft')">Craft</div>
                    </div>
                    <div id="resource-bar" style="margin-top:10px;">
                        <span>üíé: <span id="res-frag">0</span></span>
                        <span>üü´: <span id="res-dirt">0</span></span>
                        <span>üåë: <span id="res-stone">0</span></span>
                        <span>ü™µ: <span id="res-wood">0</span></span>
                        <span>üõ†Ô∏è: <span id="hud-tool">Hand</span></span>
                    </div>
                </div>

                <div class="inv-body">
                    <div id="tab-word" style="display:flex; flex-direction:column;">
                        <div class="forge-assembly">
                            <div id="zone-pre" class="forge-zone"></div>
                            <div id="zone-root" onclick="clearForgeRoot()">[ROOT]</div>
                            <div id="zone-suf" class="forge-zone"></div>
                            <button id="btn-forge" onclick="forgeWord()" style="height:60px; background:#27ae60; border:none; color:white; border-radius:8px; font-weight:bold; cursor:pointer; margin-left:15px; font-size:24px; width:60px; box-shadow: 0 4px 0 #1e8449;">üî®</button>
                        </div>

                        <div id="forge-msg">Drag items here to forge!<br>I will check the dictionary.</div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <div style="flex:1;">
                                <small style="background:#a1887f; color:white; padding:4px 8px; border-radius:4px; font-weight:bold;">ROOTS</small>
                                <div id="list-roots" class="inv-grid"></div>
                            </div>
                            <div style="flex:1;">
                                <small style="background:#90caf9; color:#0d47a1; padding:4px 8px; border-radius:4px; font-weight:bold;">AFFIXES</small>
                                <div id="list-affixes" class="inv-grid"></div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-salvage" style="display:none; flex-direction:column; align-items:center;">
                        <div style="text-align:center; margin-bottom:10px;">
                            <h3 style="margin:0; color:#5d4037;">ü™ö Salvage Station</h3>
                            <p style="font-size:14px; margin:5px 0;">Break artifacts to find rare word parts!</p>
                        </div>
                        <div id="list-artifacts" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
                    </div>

                    <div id="tab-craft" style="display:none; flex-direction:column;">
                        <div class="craft-row" style="background:#e8f5e9; border:1px solid #a5d6a7;">
                            <div class="craft-icon">üíä</div><div class="craft-desc"><span class="craft-title">Mud Poultice</span><span class="craft-cost">3 Dirt</span></div>
                            <button class="craft-btn" onclick="craft('heal_mud')">Craft</button>
                        </div>
                         <div class="craft-row" style="background:#fff3e0; border:1px solid #ffcc80;">
                            <div class="craft-icon">üî•</div><div class="craft-desc"><span class="craft-title">Campfire</span><span class="craft-cost">3 Wood</span></div>
                            <button class="craft-btn" onclick="craft('time_wood')">Craft</button>
                        </div>
                        
                        <div class="craft-row" style="background:#f3e5f5; border:1px solid #ce93d8;">
                            <div class="craft-icon">üö™</div>
                            <div class="craft-desc" onclick="setActiveBlock(6, 'Magic Door')" style="cursor:pointer;">
                                <span class="craft-title">Magic Door x3</span>
                                <span class="craft-cost">2 Wood + 1 Stone</span>
                            </div>
                            <button class="craft-btn" onclick="craft('door')">Make</button>
                        </div>

                        <hr style="width:100%; border:1px solid #ddd; margin: 15px 0;">
                        <div style="font-size:12px; color:#999; text-transform:uppercase; font-weight:bold; margin-bottom:8px;">Building Blocks (Click Name to Equip)</div>
                        <div class="craft-row"><div class="craft-icon">üß±</div><div class="craft-desc" onclick="setActiveBlock(9, 'Dirt Wall')" style="cursor:pointer;"><span class="craft-title">Dirt Wall x5</span><span class="craft-cost">3 Dirt and 2 Gemsüíé</span></div><button class="craft-btn" onclick="craft('wall')">Make</button></div>
                        <div class="craft-row"><div class="craft-icon">ü™µ</div><div class="craft-desc" onclick="setActiveBlock(4, 'Plank')" style="cursor:pointer;"><span class="craft-title">Planks x5</span><span class="craft-cost">2 Wood and 1 Gemüíé</span></div><button class="craft-btn" onclick="craft('wood')">Make</button></div>
                        <div class="craft-row"><div class="craft-icon">ü™ú</div><div class="craft-desc" onclick="setActiveBlock(13, 'Ladder')" style="cursor:pointer;"><span class="craft-title">Ladders x10</span><span class="craft-cost">3 Wood and 1 Gemüíé</span></div><button class="craft-btn" onclick="craft('ladder')">Make</button></div>
                        
                        <div class="craft-row"><div class="craft-icon">üèõÔ∏è</div><div class="craft-desc" onclick="setActiveBlock(5, 'Stone Brick')" style="cursor:pointer;"><span class="craft-title">Stone Brick x5</span><span class="craft-cost">2 Stone</span></div><button class="craft-btn" onclick="craft('stone_brick')">Make</button></div>
                        <div class="craft-row"><div class="craft-icon">üí°</div><div class="craft-desc" onclick="setActiveBlock(11, 'Sun Lantern')" style="cursor:pointer;"><span class="craft-title">Sun Lantern x3</span><span class="craft-cost">1 Wood + 1 Gem</span></div><button class="craft-btn" onclick="craft('lantern')">Make</button></div>
                        
                        <div class="craft-row"><div class="craft-icon">üèπ</div><div class="craft-desc"><span class="craft-title">Arrows x10</span><span class="craft-cost">2 Gem + 1 Wood</span></div><button class="craft-btn" onclick="craft('arrows')">Make</button></div>
<div class="craft-row" style="background:#e3f2fd; border:1px solid #90caf9;">
                            <div class="craft-icon">‚õèÔ∏è</div>
                            <div class="craft-desc">
                                <span class="craft-title">Wood Pickaxe</span>
                                <span class="craft-cost">5 Wood + 5 üíé</span>
                            </div>
                            <button class="craft-btn" onclick="craft('wood_pick')">Craft</button>
                        </div>

                        <div class="craft-row" style="background:#cfd8dc; border:1px solid #b0bec5;">
                            <div class="craft-icon">‚õèÔ∏è</div>
                            <div class="craft-desc">
                                <span class="craft-title">Stone Pickaxe</span>
                                <span class="craft-cost">5 Stone + 2 Wood + 10 üíé</span>
                            </div>
                            <button class="craft-btn" onclick="craft('stone_pick')">Craft</button>
                        </div>
                         <div class="craft-row"><div class="craft-icon">‚úíÔ∏è</div><div class="craft-desc"><span class="craft-title">Golden Quill</span><span class="craft-cost">10 Gem</span></div><button class="craft-btn" onclick="craft('quill')">Buy</button></div>
                    </div>
                </div>

                <div class="inv-footer">
                     <button class="save-btn" onclick="toggleSaveMenu(false)">üíæ Save Game</button>
                     <button class="close-btn" onclick="setGameState('playing')">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div style="color:#aaa; font-size:12px; margin-top:5px; text-align:center;">Keys: Arrows to Move | Space/T to Interact | F to Shoot | B to Build | I for Inventory</div>

<script>
    const VERSION = 3.92;
    let teacherMode = true; 
    let isForging = false; 
    
    // === AFFIX DICTIONARY ===
    const AFFIX_BRAIN = {
        "un": "not / opposite of", "re": "again / back", "sub": "under / below", "dis": "not / apart",
        "pre": "before", "mis": "wrongly / bad", "tri": "three", "bi": "two",
        "s": "more than one (plural)", "ed": "happened in the past", "ing": "happening right now",
        "ly": "done in this way (adverb)", "tion": "the action or result of", "ment": "the process or state of",
        "ness": "the state of being", "less": "without", "ful": "full of", "er": "a person who does this", "est": "the most"
    };

    // === STRICT GRAMMAR RULES ===
    const SUFFIX_RULES = {
        "s":    ["noun", "verb"],      
        "ed":   ["verb"],              
        "ing":  ["verb"],              
        "er":   ["verb", "adjective"], 
        "est":  ["adjective"],         
        "ly":   ["adjective"]          
    };
    
    const CHAR_SCALE = 1.8; 
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
    const sfx = { playTone: (f,t,d,v=0.1) => { if(!audioCtx) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=t; o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+d); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d); }, jump:()=>sfx.playTone(300,'sine',0.2), mine:()=>sfx.playTone(100,'square',0.1), shoot:()=>sfx.playTone(600,'sawtooth',0.1), build:()=>sfx.playTone(200,'triangle',0.1), collect:()=>sfx.playTone(800,'sine',0.3), hit:()=>sfx.playTone(150,'sawtooth',0.3), craft:()=>sfx.playTone(500,'square',0.5), quest:()=>sfx.playTone(600,'triangle',0.6), error:()=>sfx.playTone(100,'sawtooth',0.4) };
	function startGame() {
        // 1. Try to start audio (ignore errors if it fails)
        try { initAudio(); } catch(e) { console.log("Audio waiting for interaction"); }
        
        // 2. Force the game state change
        setGameState('playing');
        
        // 3. Ensure the start screen is hidden (Safety net)
        document.getElementById('screen-start').classList.remove('active');
    }
    // === ROBUST ASSET LOADER ===
    const assets = { tiles: new Image(), chars: new Image(), ui: new Image() };
    const processedAssets = { tiles: null, chars: null, ui: null };
    let loadedCount = 0; 
    let useFallbackAssets = false;
    let gameStarted = false;

    function checkStart() {
        if(gameStarted) return;
        if(loadedCount === 3) {
            gameStarted = true;
            processAssets();
        }
    }

    function onAssetLoad() { loadedCount++; checkStart(); }
    
    function onAssetError() { 
        console.warn("Asset failed to load. Switching to fallback mode."); 
        useFallbackAssets = true; 
        loadedCount++; 
        checkStart(); 
    }

    assets.tiles.onload = onAssetLoad; assets.tiles.onerror = onAssetError;
    assets.chars.onload = onAssetLoad; assets.chars.onerror = onAssetError;
    assets.ui.onload = onAssetLoad;    assets.ui.onerror = onAssetError;

    assets.tiles.src = 'assets/tiles.png';
    assets.chars.src = 'assets/chars.png';
    assets.ui.src = 'assets/ui.png';

    // 3. SAFETY TIMER
    setTimeout(() => {
        if(!gameStarted) {
            console.log("Loading timed out. Forcing start with fallback.");
            useFallbackAssets = true;
            gameStarted = true;
            document.getElementById('loading').style.display='none'; 
            initGame();
        }
    }, 1000);

    function removeWhite(img) { 
        try {
            const c=document.createElement('canvas'); const x=c.getContext('2d'); c.width=img.width; c.height=img.height; x.drawImage(img,0,0); const d=x.getImageData(0,0,c.width,c.height); for(let i=0;i<d.data.length;i+=4) { if(d.data[i]>240&&d.data[i+1]>240&&d.data[i+2]>240) d.data[i+3]=0; } x.putImageData(d,0,0); return c; 
        } catch(e) { return null; }
    }

    function processAssets() { 
        if(!useFallbackAssets) { 
            try {
                processedAssets.tiles=removeWhite(assets.tiles); 
                processedAssets.chars=removeWhite(assets.chars); 
                processedAssets.ui=removeWhite(assets.ui); 
            } catch(e) { useFallbackAssets = true; }
        } 
        document.getElementById('loading').style.display='none'; 
        initGame(); 
        setupMobileControls();
        
        if(localStorage.getItem('wordcraft_save') && !localStorage.getItem('wordcraft_v3_saves')) {
            try {
                const oldData = JSON.parse(localStorage.getItem('wordcraft_save'));
                const newStruct = { "Legacy_Backup": oldData };
                localStorage.setItem('wordcraft_v3_saves', JSON.stringify(newStruct));
                console.log("Migrated legacy save.");
            } catch(e) { console.error("Migration failed", e); }
        }
    }

    const TILE_SIZE=40, COLS=600, ROWS=150, CANVAS_W=800, CANVAS_H=600;
    const canvas=document.getElementById('gameCanvas'); const ctx=canvas.getContext('2d');
    canvas.width=CANVAS_W; canvas.height=CANVAS_H;
    
    const DAY_LENGTH=3600;
    let gameTick=0, camera={x:0,y:0}, keys={}, mouse={x:0,y:0};
    let stars = [];

    const LAYER_ROOTS={1:["play","help","walk","look"], 2:["happy","cycle","form","port"], 3:["struct","ject","rupt","phon"], 12:["sand","dry","sun","hot"]};
    const LAYER_AFFIXES={1:[{val:"s",type:"suf"},{val:"ed",type:"suf"},{val:"ing",type:"suf"}], 2:[{val:"un",type:"pre"},{val:"re",type:"pre"},{val:"ly",type:"suf"}], 3:[{val:"sub",type:"pre"},{val:"tion",type:"suf"},{val:"ment",type:"suf"}], 12:[{val:"ness",type:"suf"},{val:"less",type:"suf"}]};
    
    const NPCS = [
        { id: "bark", name: "Elder Bark", x: 25, y: 10, questWord: "replanting", intro: ["Greetings.", "My roots are weak.", "First, find the ANCIENT SEED.", "Dig in the dirt to find it."] },
        { id: "rusty", name: "Rusty", x: 40, y: 55, questWord: "reconstruction", intro: ["Bzzz...", "I need a GEAR.", "Dig deep in stone to find it."] },
        { id: "cloudia", name: "Cloudia", x: 30, y: 5, questWord: "formless", intro: ["Hello down there!", "I lost my shape.", "Find the CLOUD ESSENCE in the leaves.", "Forge me 'FORMLESS' to help."] },
        { id: "mike", name: "Magma Mike", x: 50, y: 140, questWord: "disruption", intro: ["RUMBLE!!", "The earth shakes!", "Find the VIBRATING CRYSTAL in obsidian.", "Forge 'DISRUPTION' to stop it!"] }
    ];
    
    const ARTIFACTS = [
        { name: "Mossy Spade", word: "REPLANTING", parts: [{t:'pre',v:'re'}, {t:'root',v:'plant'}, {t:'suf',v:'ing'}], desc: "Old tool." },
        { name: "Broken Gear", word: "RECONSTRUCTION", parts: [{t:'pre',v:'re'}, {t:'root',v:'struct'}, {t:'suf',v:'tion'}], desc: "Rusty part." },
        { name: "Stone Tablet", word: "UNCOVERED", parts: [{t:'pre',v:'un'}, {t:'root',v:'cover'}, {t:'suf',v:'ed'}], desc: "Ancient text." },
        { name: "Cloud Essence", word: "FORMLESS", parts: [{t:'root',v:'form'}, {t:'suf',v:'less'}], desc: "Wispy jar." },
        { name: "Vibrating Crystal", word: "DISRUPTION", parts: [{t:'pre',v:'dis'}, {t:'root',v:'rupt'}, {t:'suf',v:'tion'}], desc: "Shaking rock." }
    ];
    
    let state='start', grid=[], enemies=[], particles=[], projectiles=[], animTick=0;
    // ADDED tool and toolHp
let player={ 
    x:20, y:10, hp:3, maxHp:3, focus:100, maxFocus:100, fragments:0, 
    tool: "hand", toolHp: 0, // <--- NEW STATS
    resources:{dirt:0,sand:0,stone:0,wood:0,obsidian:0},roots:[], affixes:[], artifacts:[], hasQuill:false, invinc:0, facingLeft:false, blocks:{9:5,4:0,5:0,11:0,6:0,13:0}, arrows:0, activeBlock:9, quests:{bark:0, rusty:0, cloudia:0, mike:0}, unlocks:{map:false, drill:false, magnet:false, doubleFrag:false} };
// NEW TOOL DEFINITIONS
const TOOLS = {
    "hand": { tier: 0, name: "Bare Hands" },
    "wood_pick": { tier: 1, maxHp: 30, name: "Wood Pickaxe" },
    "stone_pick": { tier: 2, maxHp: 50, name: "Stone Pickaxe" },
    "iron_pick": { tier: 3, maxHp: 100, name: "Iron Pickaxe" }
};
    let currentDialogue = null;
    let moveCooldown = 0; // Added for movement timing

    function initGame() {
        grid=[];
        for(let r=0; r<ROWS; r++){
            let row=[];
            for(let c=0; c<COLS; c++){
                let s = 10 + Math.floor(Math.sin(c*0.05)*5);
                let isCave = (r>s+8) && (Math.random()<0.12);
                if(r<s) row.push(0); else if(isCave) row.push(0); else if(r<s+5) row.push(1); else if(r<s+15) row.push(12); else if(r<s+60) row.push(2); else row.push(3);
            }
            grid.push(row);
        }
        
        for(let c=5; c<COLS-5; c++) {
            let s = 10 + Math.floor(Math.sin(c*0.05)*5);
            if(Math.random() < 0.08) {
                let h = 3 + Math.floor(Math.random() * 3);
                for(let i=0; i<h; i++) { if(grid[s-1-i][c] === 0) grid[s-1-i][c] = 7; }
                for(let lx=-1; lx<=1; lx++) {
                    for(let ly=-1; ly<=1; ly++) {
                        let ty = s - 1 - h + ly; let tx = c + lx;
                        if(tx>=0 && tx<COLS && ty>=0 && ty<ROWS && grid[ty][tx] === 0) { grid[ty][tx] = 8; }
                    }
                }
            }
        }

        stars = [];
        for(let i=0; i<150; i++) {
            stars.push({ x: Math.random() * CANVAS_W, y: Math.random() * (CANVAS_H*0.6), size: Math.random() * 2 + 1, twinkleOffset: Math.random() * Math.PI * 2 });
        }
        
        spawnEnemyBatch(40, true);
        
        let gy=0; while(gy<ROWS && grid[gy][20]===0) gy++; player.y=gy-1;
        NPCS.forEach(n => {
            if(n.id === 'bark') { let s = 10 + Math.floor(Math.sin(n.x*0.05)*5); n.y = s - 1; }
            if(n.id === 'rusty') { grid[n.y][n.x] = 0; grid[n.y-1][n.x] = 0; if(grid[n.y+1][n.x] === 0) grid[n.y+1][n.x] = 5; }
            if(n.id === 'mike') { 
                for(let mx=-1; mx<=1; mx++) for(let my=-1; my<=1; my++) grid[n.y+my][n.x+mx] = 0;
                grid[n.y+2][n.x] = 3; 
            }
        });
        requestAnimationFrame(loop);
    }
    
    function spawnEnemyBatch(count, forceDeep) { for(let i=0; i<count; i++) spawnEnemy(forceDeep); }
    
    function spawnEnemy(forceDeep = false) {
        for(let i=0; i<20; i++) {
            let c, r;
            let isNight = (gameTick % DAY_LENGTH) > (DAY_LENGTH * 0.5);

            if(!forceDeep && isNight) {
                 let offsetX = Math.floor(Math.random() * 40) - 20; 
                 c = Math.max(0, Math.min(COLS-1, player.x + offsetX));
                 r = Math.floor(Math.random() * 25); 
                 if(i===0 && Math.abs(c-player.x) < 20) addPart(player.x, player.y-2, "!", "red");
            } else {
                 c = Math.floor(Math.random() * COLS);
                 r = Math.floor(Math.random() * (ROWS - 30)) + 30;
            }

            if(r >= 0 && r < ROWS && grid[r][c] === 0) { 
                enemies.push({ x:c, y:r, type: Math.random()>.5?'bat':'slime', hp:2, speed:15, stun:0 }); 
                return; 
            }
        }
    }

    function loop() { if(state==='playing') update(); draw(); requestAnimationFrame(loop); }

    function update() {document.getElementById('focus-fill').style.width = (player.focus/player.maxFocus*100) + "%";
        animTick++; gameTick++; if(player.invinc>0) player.invinc--;
        
        // Handle Frame-Based Player Movement (standard for held keys)
        if(moveCooldown > 0) moveCooldown--;
        else movePlayer();

        let tX=(player.x*TILE_SIZE)-(CANVAS_W/2), tY=(player.y*TILE_SIZE)-(CANVAS_H/2);
        camera.x=Math.max(0,Math.min(tX,(COLS*TILE_SIZE)-CANVAS_W)); camera.y=Math.max(0,Math.min(tY,(ROWS*TILE_SIZE)-CANVAS_H));

        let tod=gameTick%DAY_LENGTH; let isNight = tod > (DAY_LENGTH * 0.5);
        if(gameTick % 200 === 0 && enemies.length < 60) { spawnEnemy(); }

	let tName = TOOLS[player.tool].name;
	if (player.tool !== "hand") tName += ` (${player.toolHp})`;
	document.getElementById('hud-tool').innerText = tName;

        enemies.forEach((en,i)=>{
            if(en.stun>0) { en.stun--; return; }
            if(!isNight && en.y < 20) { if(Math.random() < 0.02) addPart(en.x, en.y-1, "z", "#888"); return; }
            if(Math.abs(en.x-player.x)<30 && Math.abs(en.y-player.y)<20) {
                if(animTick%en.speed===0) {
                    let nx=en.x, ny=en.y;
                    if(en.x<player.x) nx++; else if(en.x>player.x) nx--; else if(en.y<player.y) ny++; else if(en.y>player.y) ny--;
                    if(grid[ny][nx]===0 || grid[ny][nx]===13) { en.x=nx; en.y=ny; } 
                }
                if(en.x===player.x && en.y===player.y) hurtPlayer();
            }
        });
        
        for(let i=projectiles.length-1; i>=0; i--) {
            let p=projectiles[i]; p.x+=p.vx; p.y+=p.vy;
            let gx=Math.round(p.x), gy=Math.round(p.y), hit=false;
            enemies.forEach((en,ei)=>{ if(Math.round(en.x)===gx && Math.round(en.y)===gy) { en.hp--; hit=true; sfx.hit(); if(en.hp<=0) {enemies.splice(ei,1); player.fragments+=3;} } });
            if(gx<0||gx>=COLS||gy<0||gy>=ROWS||(grid[gy][gx]!==0)||hit) projectiles.splice(i,1);
        }
        
        if(player.unlocks.magnet) {
             for(let i=particles.length-1; i>=0; i--) { 
                 let p = particles[i];
                 if(p.life > 0 && Math.abs(p.x - player.x) < 5 && Math.abs(p.y - player.y) < 5) {
                     p.x += (player.x - p.x) * 0.1;
                     p.y += (player.y - p.y) * 0.1;
                 }
             }
        }
        
        for(let i=particles.length-1; i>=0; i--) { particles[i].life--; particles[i].y-=0.05; if(particles[i].life<=0) particles.splice(i,1); }
    }

    // NEW: Centralized movement logic to support simultaneous held keys/buttons
    function movePlayer() {
        let dx = 0, dy = 0;
        if(keys['ArrowLeft']) { dx = -1; player.facingLeft = true; }
        if(keys['ArrowRight']) { dx = 1; player.facingLeft = false; }
        if(keys['ArrowUp']) dy = -1;
        if(keys['ArrowDown']) dy = 1;

        if(dx !== 0 || dy !== 0) {
            let nx = player.x + dx, ny = player.y + dy;
            if(nx >= 0 && nx < COLS && ny >= 0 && ny < ROWS) {
                let t = grid[ny][nx];
                let currentT = grid[player.y][player.x];
                // Allow movement if entering air, ladder, door, or if current tile is ladder
                if (currentT === 13 || t === 13 || t === 0 || t === 6 || t === 11) {
                    player.x = nx; player.y = ny;
                    moveCooldown = 8; // Adjust this value to control walk speed
                }
            }
        }
    }

    document.addEventListener('keydown', e=>{
        if(e.key===' ') e.preventDefault();
        keys[e.key]=true;
        if(state!=='playing') return;
        
        // Actions that aren't movement (Discrete presses)
        if(e.key===' ') interact(); if(e.key==='f'||e.key==='F') shootArrow();
        if(e.key==='i'||e.key==='I') setGameState('inventory'); if(e.key==='b'||e.key==='B') placeBlock();
        if(e.key==='t'||e.key==='T') interact(); if(e.key==='m'||e.key==='M') toggleMap();
    });
    document.addEventListener('keyup', e=>{ keys[e.key]=false; });

    // === FIXED MOBILE CONTROLS LOGIC (Optimized for Multi-Touch) ===
    function setupMobileControls() {
        const touchBtns = document.querySelectorAll('.touch-btn');
        touchBtns.forEach(btn => {
            const key = btn.getAttribute('data-key');
            
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                initAudio(); // Initialize audio context on first interaction
                
                if(key === 'i' || key === 'I') {
                    setGameState('inventory');
                } else if(key === 'b') {
                    placeBlock();
                } else if(key === ' ') {
                    interact();
                } else if(key === 'f') {
                    shootArrow();
                } else if(key === 'action') {
                    action();
                } else {
                    // This sets the movement key to true in the 'keys' object
                    keys[key] = true;
                }
                btn.style.transform = "scale(0.9)";
            }, { passive: false });

            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                // When finger is lifted, set movement key to false
                if(key && key.startsWith('Arrow')) {
                    keys[key] = false;
                }
                btn.style.transform = "scale(1)";
            }, { passive: false });
            
            // Safety: Clear keys if touch is cancelled (e.g., finger slides off screen)
            btn.addEventListener('touchcancel', (e) => {
                if(key && key.startsWith('Arrow')) keys[key] = false;
                btn.style.transform = "scale(1)";
            });
        });
    }
function showToast(msg, type='neutral') {
        let t = document.getElementById('toast-msg');
        t.innerText = msg; t.className = "toast show " + type;
        setTimeout(() => t.className = "toast", 2500);
    }
    function toggleMobileControls() {
        let el = document.getElementById('mobile-controls'); let btn = document.getElementById('mob-toggle');
        let isOn = btn.classList.contains('on');
        if(isOn) { el.style.display = 'none'; btn.classList.remove('on'); } else { el.style.display = 'block'; btn.classList.add('on'); }
    }

    function interact() {
        let talked = false;
        NPCS.forEach(n => { if(Math.abs(player.x - n.x) <= 2 && Math.abs(player.y - n.y) <= 2) { startDialogue(n); talked = true; } });
        if(talked) return; action();
    }

    function startDialogue(npc) {
        let box = document.getElementById('dialogue-box'); let text = document.getElementById('dialogue-text');
        box.style.display = 'block'; document.querySelector('.npc-name').innerText = npc.name;
        let qState = player.quests[npc.id]; let lines = [];
        
        if(npc.id === 'bark') {
            if(qState === 3) lines = ["The forest is safe now.", "Use the Map I gave you."];
            else if(qState === 2) lines = ["You found the Seed!", "Now use the Forge to make REPLANTING."];
            else if(qState === 1) lines = ["Have you found the seed?", "Check the Dirt layers."];
            else { lines = npc.intro; player.quests[npc.id] = 1; alert("Quest Started: Find the Seed!"); }
        } 
        else if(npc.id === 'rusty') {
            if(qState === 3) lines = ["Systems optimized.", "The Drill is yours."];
            else if(qState === 2) lines = ["Gear acquired.", "Forge RECONSTRUCTION to fix me."];
            else if(qState === 1) lines = ["I need the Gear...", "It is in the Stone."];
            else { lines = npc.intro; player.quests[npc.id] = 1; alert("Quest Started: Find the Gear!"); }
        }
        else if(npc.id === 'cloudia') {
            if(qState === 3) lines = ["I feel lighter!", "My Magnet Aura is yours."];
            else if(qState === 2) lines = ["You found my Essence!", "Forge FORMLESS to restore me."];
            else if(qState === 1) lines = ["Search the tree leaves...", "My essence is hidden there."];
            else { lines = npc.intro; player.quests[npc.id] = 1; alert("Quest Started: Find Cloud Essence!"); }
        }
        else if(npc.id === 'mike') {
            if(qState === 3) lines = ["The shaking stopped!", "Take this Golden Quill."];
            else if(qState === 2) lines = ["You found the Crystal!", "Forge DISRUPTION to counter it."];
            else if(qState === 1) lines = ["Dig deep into obsidian...", "Find the Vibrating Crystal."];
            else { lines = npc.intro; player.quests[npc.id] = 1; alert("Quest Started: Stop the Quake!"); }
        }
        
        currentDialogue = { lines: lines, index: 0 }; text.innerText = lines[0];
    }
    
    function advanceDialogue() {
        if(!currentDialogue) return;
        currentDialogue.index++;
        if(currentDialogue.index < currentDialogue.lines.length) { document.getElementById('dialogue-text').innerText = currentDialogue.lines[currentDialogue.index]; } 
        else { document.getElementById('dialogue-box').style.display = 'none'; currentDialogue = null; }
    }

    function action() {
        // Coordinate Logic
        let tx = player.x + (player.facingLeft ? -1 : 1);
        let ty = player.y;
        if (keys['ArrowUp']) { tx = player.x; ty = player.y - 1; }
        else if (keys['ArrowDown']) { tx = player.x; ty = player.y + 1; }
        
        if (tx >= 0 && tx < COLS && ty >= 0 && ty < ROWS) {
            let t = grid[ty][tx];
            if (t > 0) {
                if ((t === 6 || t === 11 || t === 13) && !keys['b']) return;

                // === 1. TOOL TIER CHECK ===
                let requiredTier = 0;
                if (t === 2) requiredTier = 1;
                if (t === 3) requiredTier = 2;

                let currentTier = TOOLS[player.tool].tier;

                if (currentTier < requiredTier) {
                    let needed = (requiredTier === 1) ? "Wood Pickaxe" : "Stone Pickaxe";
                    showToast(`Too hard! You need a ${needed}.`, "warn");
                    return;
                }

                // === 2. FOCUS CHECK ===
                let cost = (t === 1 || t === 12 || t === 8) ? 0 : 2;
                if (player.focus < cost) { showToast("Too tired! Mine Dirt/Leaves.", "warn"); return; }
                player.focus -= cost;

                // === 3. DURABILITY SYSTEM ===
                if (player.tool !== "hand") {
                    player.toolHp--;
                    if (player.toolHp <= 0) {
                        player.tool = "hand";
                        player.toolHp = 0;
                        alert("CRACK! Your tool broke!");
                        sfx.error(); 
                    }
                }

                // === 4. MINING SUCCESS ===
                grid[ty][tx] = 0;
                sfx.mine();
                addPart(tx, ty, "‚ú®");
                
                // Drop Logic
                if (t === 1) player.resources.dirt++;
                else if (t === 12) player.resources.sand++;
                else if (t === 2) player.resources.stone++;
                else if (t === 3) player.resources.obsidian++;
                else if (t === 7) player.resources.wood++;
                
                // === QUEST ITEMS ===
                let foundSpecial = false;
                if (player.quests.bark === 1 && t === 1 && Math.random() < 0.15) {
                    player.quests.bark = 2; addPart(player.x, player.y - 1, "üå∞", "lightgreen"); alert("You found the ANCIENT SEED!"); sfx.quest(); foundSpecial = true;
                } else if (player.quests.rusty === 1 && t === 2 && Math.random() < 0.15) {
                    player.quests.rusty = 2; addPart(player.x, player.y - 1, "‚öôÔ∏è", "gray"); alert("You found the RUSTY GEAR!"); sfx.quest(); foundSpecial = true;
                } else if (player.quests.cloudia === 1 && t === 8 && Math.random() < 0.25) {
                    player.quests.cloudia = 2; addPart(player.x, player.y - 1, "‚òÅÔ∏è", "white"); alert("You found CLOUD ESSENCE!"); sfx.quest(); foundSpecial = true;
                } else if (player.quests.mike === 1 && t === 3 && Math.random() < 0.15) {
                    player.quests.mike = 2; addPart(player.x, player.y - 1, "‚ö°", "red"); alert("You found the VIBRATING CRYSTAL!"); sfx.quest(); foundSpecial = true;
                }

                // === WORD PART DROPS ===
                if (!foundSpecial && Math.random() < 0.4) {
                    let type = "root";
                    let val = "";

                    // DIRT LAYER (t=1)
                    if (t === 1) {
                        // 1. EXPANDED POOL: Added er, est, ly, tri, bi
                        let pool = ["s", "ed", "ing", "er", "est", "ly", "un", "re", "dis", "mis", "pre", "tri", "bi"];
                        
                        if (Math.random() < 0.4) { 
                            let roots = ["play", "help", "jump", "cook", "read", "mix", "walk", "look", "paint"];
                            val = roots[Math.floor(Math.random() * roots.length)];
                        } else { 
                            val = pool[Math.floor(Math.random() * pool.length)];
                            // Check if it's a prefix
                            type = (["un","re","dis","mis","pre","tri","bi"].includes(val)) ? "pre" : "suf";
                        }
                    } 
                    // STONE LAYER (t=2)
                    else if (t === 2) {
                        let pool = ["tion", "ment", "ness", "ful", "less", "sub", "auto", "inter", "super"];
                        if (Math.random() < 0.5) {
                            let roots = ["struct", "ject", "rupt", "spec", "dict", "port", "form", "grath"];
                            val = roots[Math.floor(Math.random() * roots.length)];
                        } else {
                            val = pool[Math.floor(Math.random() * pool.length)];
                            type = (["sub","auto","inter","super"].includes(val)) ? "pre" : "suf";
                        }
                    }
                    // SAND LAYER (t=12) - This was missing before!
                    else if (t === 12) {
                        let pool = ["less", "ness", "ful", "y", "er"];
                         if (Math.random() < 0.4) {
                             let roots = ["sand", "dry", "sun", "hot", "quick"];
                             val = roots[Math.floor(Math.random() * roots.length)];
                         } else {
                             val = pool[Math.floor(Math.random() * pool.length)];
                             type = "suf";
                         }
                    }
                    // DEFAULT (Leaves, Wood, etc.)
                    else { 
                         // 2. FIXED FALLBACK: No longer just "ing"
                         let pool = ["s", "ing", "er", "ed"];
                         val = pool[Math.floor(Math.random() * pool.length)];
                         type = "suf"; 
                    }

                    if (type === "root") player.roots.push({word: val, type: t});
                    else player.affixes.push({val: val, type: type});
                    
                    showToast(`Found "${val}"`, "good");
                }
            }
        }
    }
    function placeBlock() { 
        let id=player.activeBlock; 
        if(player.blocks[id]>0 && grid[player.y][player.x]===0) { 
            if(player.focus < 5) { showToast("Brain Fog! Forge words to recharge.", "warn"); return; }
            player.focus -= 5;
            grid[player.y][player.x]=id; 
            player.blocks[id]--; 
            sfx.build(); 
        } 
    }
    function shootArrow() { if(player.arrows>0) { player.arrows--; projectiles.push({x:player.x,y:player.y,vx:(player.facingLeft?-1:1),vy:0}); sfx.shoot(); } }
    function addPart(x,y,c,cl="white") { particles.push({x:x,y:y,char:c,color:cl,life:30}); }
    function hurtPlayer() { if(player.invinc>0) return; player.hp--; player.invinc=30; sfx.hit(); if(player.hp<=0) setGameState('death'); }

    function draw() {
        let tod=gameTick%DAY_LENGTH; let cp = Math.sin((tod / DAY_LENGTH) * Math.PI); 
        let r = Math.floor(135 * cp + 20 * (1-cp)); let g = Math.floor(206 * cp + 20 * (1-cp)); let b = Math.floor(235 * cp + 60 * (1-cp));
        ctx.fillStyle=`rgb(${r},${g},${b})`; ctx.fillRect(0,0,CANVAS_W,CANVAS_H);

        if(cp < 0.5) {
                ctx.fillStyle = "white"; let starOpacity = 1 - (cp * 2); 
                stars.forEach(s => { let twinkle = Math.sin((gameTick / 10) + s.twinkleOffset) * 0.3 + 0.7; ctx.globalAlpha = starOpacity * twinkle; ctx.fillRect(s.x, s.y, s.size, s.size); });
                ctx.globalAlpha = 1.0; 
        }

        let tW=useFallbackAssets?TILE_SIZE:processedAssets.tiles.width; let tH=useFallbackAssets?TILE_SIZE:processedAssets.tiles.height/5;
        let cX=Math.floor(camera.x/TILE_SIZE), cY=Math.floor(camera.y/TILE_SIZE);
        let eX=cX+(CANVAS_W/TILE_SIZE)+1, eY=cY+(CANVAS_H/TILE_SIZE)+1;

        ctx.save(); ctx.translate(-camera.x, -camera.y);

        for(let r=cY; r<=eY; r++){
            for(let c=cX; c<=eX; c++){
                if(r>=0 && r<ROWS && c>=0 && c<COLS) {
                    let t=grid[r][c];
                    if(player.unlocks.map && t>0) ctx.globalAlpha = 0.5; 
                    if(t>0) {
                            if(useFallbackAssets) { 
                                if(t===6) ctx.fillStyle="purple"; 
                                else if(t===5) ctx.fillStyle="#7f8c8d"; 
                                else if(t===11) ctx.fillStyle="#f1c40f"; 
                                else if(t===13) ctx.fillStyle="#d35400"; 
                                else if(t===7) ctx.fillStyle="#5d4037"; 
                                else if(t===8) ctx.fillStyle="#2ecc71"; 
                                else ctx.fillStyle="brown"; 
                                ctx.fillRect(c*TILE_SIZE,r*TILE_SIZE,TILE_SIZE,TILE_SIZE); 
                            }
                            else {
                                if(t===6) { ctx.fillStyle="#9b59b6"; ctx.fillRect(c*TILE_SIZE,r*TILE_SIZE,TILE_SIZE,TILE_SIZE); ctx.strokeStyle="#8e44ad"; ctx.lineWidth=3; ctx.strokeRect(c*TILE_SIZE,r*TILE_SIZE,TILE_SIZE,TILE_SIZE); } 
                                else if(t===5) { ctx.fillStyle="#95a5a6"; ctx.fillRect(c*TILE_SIZE,r*TILE_SIZE,TILE_SIZE,TILE_SIZE); ctx.strokeStyle="#7f8c8d"; ctx.lineWidth=2; ctx.strokeRect(c*TILE_SIZE+2,r*TILE_SIZE+2,TILE_SIZE-4,TILE_SIZE-4); }
                                else if(t===11) { ctx.fillStyle="#f1c40f"; ctx.beginPath(); ctx.arc(c*TILE_SIZE+20, r*TILE_SIZE+20, 15, 0, 2*Math.PI); ctx.fill(); ctx.shadowBlur=20; ctx.shadowColor="yellow"; }
                                else if(t===13) { ctx.fillStyle="#5d4037"; ctx.fillRect(c*TILE_SIZE+10,r*TILE_SIZE,5,TILE_SIZE); ctx.fillRect(c*TILE_SIZE+25,r*TILE_SIZE,5,TILE_SIZE); for(let li=0; li<4; li++) ctx.fillRect(c*TILE_SIZE+10, r*TILE_SIZE+(li*10), 20, 3); }
                                else if(t===7) { ctx.fillStyle="#3e2723"; ctx.fillRect(c*TILE_SIZE,r*TILE_SIZE,TILE_SIZE,TILE_SIZE); ctx.strokeStyle="#5d4037"; ctx.lineWidth=2; ctx.strokeRect(c*TILE_SIZE+5,r*TILE_SIZE,TILE_SIZE-10,TILE_SIZE); }
                                else if(t===8) { ctx.fillStyle="rgba(46, 204, 113, 0.8)"; ctx.fillRect(c*TILE_SIZE+2,r*TILE_SIZE+2,TILE_SIZE-4,TILE_SIZE-4); }
                                else { let tidx = (t<=3) ? t-1 : (t===12?0:(t===9?3:0)); ctx.drawImage(processedAssets.tiles, tW*0.4, (tidx*tH)+tH*0.2, tW*0.2, tH*0.6, c*TILE_SIZE, r*TILE_SIZE, TILE_SIZE+1, TILE_SIZE+1); }
                            }
                    }
                    ctx.globalAlpha = 1.0;
                    ctx.shadowBlur=0;
                }
            }
        }
        
        NPCS.forEach(n => {
            // TITAN RENDER
            ctx.save();
            ctx.shadowBlur = 30; 
            if (n.id === 'bark') ctx.shadowColor = "lime";
            else if (n.id === 'rusty') ctx.shadowColor = "cyan";
            else if (n.id === 'cloudia') ctx.shadowColor = "white";
            else if (n.id === 'mike') ctx.shadowColor = "orange";
            else ctx.shadowColor = "white";

            let char = "ü§ñ";
            if (n.id === 'bark') char = "üå≥";
            if (n.id === 'cloudia') char = "üßö";
            if (n.id === 'mike') char = "üåã";

            ctx.font = "100px Arial"; 
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            ctx.fillStyle = "white"; 
            
            ctx.fillText(char, (n.x * TILE_SIZE) + (TILE_SIZE/2), (n.y * TILE_SIZE) + TILE_SIZE + 10);
            ctx.restore();

            if(Math.abs(player.x - n.x) <= 3 && Math.abs(player.y - n.y) <= 3) {
                ctx.font = "bold 16px Verdana";
                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                ctx.strokeStyle = "black";
                ctx.lineWidth = 3;
                ctx.strokeText("PRESS T", (n.x * TILE_SIZE) + (TILE_SIZE/2), (n.y * TILE_SIZE) - 80);
                ctx.fillText("PRESS T", (n.x * TILE_SIZE) + (TILE_SIZE/2), (n.y * TILE_SIZE) - 80);
            }
        });
        ctx.textBaseline = "alphabetic";

        if(!useFallbackAssets) {
            let cW=processedAssets.chars.width/3, cH=processedAssets.chars.height/3; let drawSize = TILE_SIZE * CHAR_SCALE; let offset = (drawSize - TILE_SIZE) / 2;
            ctx.save(); 
            if(player.facingLeft) { ctx.translate((player.x*TILE_SIZE)+TILE_SIZE, player.y*TILE_SIZE); ctx.scale(-1,1); ctx.drawImage(processedAssets.chars, (Math.floor(animTick/20)%2)*cW, 0, cW, cH, -offset, -offset, drawSize, drawSize); } 
            else { ctx.drawImage(processedAssets.chars, (Math.floor(animTick/20)%2)*cW, 0, cW, cH, (player.x*TILE_SIZE)-offset, (player.y*TILE_SIZE)-offset, drawSize, drawSize); }
            ctx.restore();
            enemies.forEach(en=>{ ctx.drawImage(processedAssets.chars, (Math.floor(animTick/10)%3)*cW, (en.type==='bat'?1:2)*cH, cW, cH, (en.x*TILE_SIZE)-offset, (en.y*TILE_SIZE)-offset, drawSize, drawSize); });
        } else {
             ctx.fillStyle="blue"; ctx.fillRect(player.x*TILE_SIZE, player.y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
             enemies.forEach(en=>{ 
                 ctx.fillStyle=(en.type==='bat'?"red":"lime"); 
                 ctx.fillRect(en.x*TILE_SIZE, en.y*TILE_SIZE, TILE_SIZE, TILE_SIZE); 
             });
        }
        
        ctx.fillStyle="yellow"; projectiles.forEach(p=>ctx.fillRect(p.x*TILE_SIZE,p.y*TILE_SIZE,5,5));
        ctx.font="20px Arial"; particles.forEach(p=>{ctx.fillStyle=p.color; ctx.fillText(p.char,p.x*TILE_SIZE,p.y*TILE_SIZE)});
        ctx.restore();

        ctx.fillStyle="white"; ctx.font="bold 20px Verdana"; ctx.fillText(player.fragments, 100, 30);
        ctx.font="14px Verdana"; ctx.fillText(player.unlocks.drill?"Drill Active!":"Pickaxe", 10, 50);
        let isNight = tod > (DAY_LENGTH * 0.5); ctx.fillText(isNight ? "üåô Night" : "‚òÄÔ∏è Day", 10, 70);
    }
    
    function setGameState(s) { 
        state = s; 
        // 1. Hide all open windows first
        document.querySelectorAll('.popup').forEach(e => e.classList.remove('active')); 
        
        // 2. Show the specific window based on the state
        if(s === 'start') document.getElementById('screen-start').classList.add('active'); 
        if(s === 'inventory') { 
            document.getElementById('screen-inv').classList.add('active'); 
            renderInventory(); 
            renderForgeUI(); 
        } 
        
        // --- THIS WAS MISSING ---
        if(s === 'death') document.getElementById('screen-death').classList.add('active'); 
        // ------------------------

        if(s === 'playing') initAudio(); 
    }

    function switchTab(t) { 
        document.getElementById('tab-word').style.display=t==='word'?'flex':'none'; document.getElementById('tab-craft').style.display=t==='craft'?'flex':'none'; document.getElementById('tab-salvage').style.display=t==='salvage'?'flex':'none'; 
        if(t==='salvage') renderSalvage(); else renderInventory(); 
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')); event.target.classList.add('active'); 
    }

    function renderInventory() { 
        let d=document.getElementById('list-roots'); d.innerHTML=""; 
        if(player.roots.length===0) d.innerHTML="<small>Empty. Go Dig!</small>";
        else player.roots.forEach(r => { let s = document.createElement('div'); s.className="word-chip chip-root"; s.innerText=r.word; s.onclick=()=>setSlot('root',r.word); d.appendChild(s); });

        let da=document.getElementById('list-affixes'); da.innerHTML="";
        if(player.affixes.length===0) da.innerHTML="<small>Empty.</small>";
        else player.affixes.forEach(a => {
            let s = document.createElement('div'); let typeClass = (a.type==="pre") ? "chip-pre" : "chip-suf"; s.className=`word-chip ${typeClass}`; 
            let displayVal = (a.type==="pre") ? a.val+"-" : "-"+a.val; s.innerText=displayVal; s.onclick=()=>setSlot(a.type, a.val); da.appendChild(s);
        });
        
        document.getElementById('res-frag').innerText = player.fragments; document.getElementById('res-dirt').innerText = player.resources.dirt; document.getElementById('res-stone').innerText = player.resources.stone; document.getElementById('res-wood').innerText = player.resources.wood;
    }

    function renderSalvage() { 
        let d=document.getElementById('list-artifacts'); d.innerHTML=""; 
        if(player.artifacts.length===0) d.innerHTML="<div style='padding:20px'>Go mine!</div>";
        player.artifacts.forEach((a,i)=>{ d.innerHTML+=`<div class='artifact-item'><div><div class='artifact-word'>${a.word}</div><div style='font-size:12px;color:#f1c40f'>${a.desc}</div></div><button class='salvage-btn' onclick='salvageItem(${i},this)'>BREAK</button></div>`; });
    }

    function salvageItem(i,btn) {
        if(!player.artifacts[i]) return;
        btn.parentElement.classList.add('break-anim'); sfx.mine();
        setTimeout(()=>{
            let it=player.artifacts[i]; let gotList = [];
            it.parts.forEach(p=>{ if(p.t==='root') player.roots.push({word:p.v,type:1}); else player.affixes.push({val:p.v,type:p.t}); gotList.push(p.v); });
            player.artifacts.splice(i,1); player.fragments+=5;
            alert("Salvaged: " + it.word + "\nReceived: " + gotList.join(", ")); renderSalvage(); renderInventory();
        },400);
    }
    
    // === SPELLING LOGIC (FIXED) ===
    function fixSpelling(root, suf) {
        if(!suf) return { word: root, rule: null, displayHTML: root };
        const vowels = ['a','e','i','o','u','y'];
        const isVowel = (c) => vowels.includes(c);
        const endsInCVC = (str) => {
            if(str.length < 3) return false;
            const last3 = str.slice(-3);
            if(['w','x','y'].includes(str.slice(-1))) return false; 
            return !isVowel(last3[0]) && isVowel(last3[1]) && !isVowel(last3[2]);
        };
        let lastChar = root.slice(-1);
        let secondLast = root.slice(-2, -1);

        // 1. Dry -> Dries
        if(lastChar === 'y' && !isVowel(secondLast) && suf === 's') {
             let cutRoot = root.slice(0, -1);
             return { word: cutRoot + "ies", rule: "Changed 'y' to 'i' and added 'es'!", displayHTML: `${cutRoot}<span class='morph-highlight'>ies</span>` };
        }
        // 2. Silent E
        if(lastChar === 'e' && isVowel(suf[0])) { 
            let cutRoot = root.slice(0, -1);
            return { word: cutRoot + suf, rule: "Dropped the silent 'e'!", displayHTML: `${cutRoot}<span class='morph-highlight'>${suf.charAt(0)}</span>${suf.slice(1)}` }; 
        }
        // 3. Y to I
        if(lastChar === 'y' && !isVowel(secondLast)) {
            if(suf[0] === 'i') return { word: root + suf, rule: "Kept 'y' (suffix starts with 'i').", displayHTML: root + suf };
            return { word: root.slice(0, -1) + 'i' + suf, rule: "Changed 'y' to 'i'!", displayHTML: `${root.slice(0,-1)}<span class='morph-highlight'>i</span>${suf}` }; 
        }
        // 4. Doubling
        if(endsInCVC(root) && isVowel(suf[0])) { 
            return { word: root + lastChar + suf, rule: "Doubled the final consonant!", displayHTML: `${root}<span class='morph-highlight'>${lastChar}</span>${suf}` }; 
        }
        return { word: root + suf, rule: null, displayHTML: root + suf };
    }

    let forge = { pres: [], root: null, sufs: [] };

    function setSlot(type, val) {
        if(type === 'root') { forge.root = val; } 
        else if (type === 'pre') { if(forge.pres.length < 3) forge.pres.push(val); else alert("Too many prefixes!"); } 
        else if (type === 'suf') { if(forge.sufs.length < 3) forge.sufs.push(val); else alert("Too many suffixes!"); }
        renderForgeUI();
    }

    function removeForgeItem(type, index) {
        if(type === 'pre') forge.pres.splice(index, 1);
        if(type === 'suf') forge.sufs.splice(index, 1);
        renderForgeUI();
    }

    function clearForgeRoot() { forge.root = null; renderForgeUI(); }

    function renderForgeUI() {
        const zPre = document.getElementById('zone-pre');
        zPre.innerHTML = "";
        if (forge.pres.length === 0) { zPre.innerHTML = `<div style="color:#aaa; font-size:12px; border: 2px dashed #ccc; padding:5px 10px; border-radius:8px;">[Pre]</div>`; } 
        else { forge.pres.forEach((p, i) => { zPre.innerHTML += `<div class="mini-chip chip-pre" onclick="removeForgeItem('pre', ${i})">${p}-</div>`; }); }

        const zRoot = document.getElementById('zone-root');
        if(forge.root) { zRoot.innerText = forge.root; zRoot.classList.add('occupied'); zRoot.classList.remove('chip-root'); zRoot.style.background = "#c8e6c9"; } 
        else { zRoot.innerText = "[ROOT]"; zRoot.classList.remove('occupied'); zRoot.style.background = "rgba(255,255,255,0.8)"; }

        const zSuf = document.getElementById('zone-suf');
        zSuf.innerHTML = "";
        if (forge.sufs.length === 0) { zSuf.innerHTML = `<div style="color:#aaa; font-size:12px; border: 2px dashed #ccc; padding:5px 10px; border-radius:8px;">[Suf]</div>`; } 
        else { forge.sufs.forEach((s, i) => { zSuf.innerHTML += `<div class="mini-chip chip-suf" onclick="removeForgeItem('suf', ${i})">-${s}</div>`; }); }
    }

    function consumeItems() {
        let rIdx = player.roots.findIndex(r => r.word === forge.root);
        if(rIdx > -1) player.roots.splice(rIdx, 1);
        forge.pres.forEach(pVal => { let idx = player.affixes.findIndex(a => a.val === pVal && a.type === "pre"); if(idx > -1) player.affixes.splice(idx, 1); });
        forge.sufs.forEach(sVal => { let idx = player.affixes.findIndex(a => a.val === sVal && a.type === "suf"); if(idx > -1) player.affixes.splice(idx, 1); });
        forge = { pres: [], root: null, sufs: [] };
        renderForgeUI();
    }
    
    // === STRICT FORGE PROCESSOR ===
    async function forgeWord() {
        if(isForging) return; 
        if(!forge.root) { alert("You need a Root word!"); return; }

        isForging = true;
        let btn = document.getElementById('btn-forge');
        let originalBtnText = btn.innerText;
        btn.innerText = "‚è≥"; btn.classList.add('btn-disabled');

        let m = document.getElementById('forge-msg');
        m.innerHTML = "Consulting the Lexicon..."; sfx.craft();
        
        let currentWord = forge.root.toLowerCase();
        let ruleLog = []; 

        forge.sufs.forEach(suf => {
            let res = fixSpelling(currentWord, suf.toLowerCase());
            currentWord = res.word;
            if(res.rule) ruleLog.push(res.rule);
        });

        let prefixStr = forge.pres.join("");
        let finalWord = prefixStr + currentWord;
        let rootOnly = forge.root.toLowerCase();

        let questTriggered = false;
        NPCS.forEach(n => {
            if(player.quests[n.id] === 2 && finalWord === n.questWord) {
                player.quests[n.id] = 3; 
                if(n.id === 'bark') player.unlocks.map = true;
                if(n.id === 'rusty') player.unlocks.drill = true;
                if(n.id === 'cloudia') player.unlocks.magnet = true;
                if(n.id === 'mike') player.unlocks.doubleFrag = true;
                alert(`QUEST COMPLETE: Reward Unlocked!`); sfx.quest();
                questTriggered = true; consumeItems();
                m.innerHTML = `<span style="color:green;font-weight:bold">QUEST COMPLETE!</span>`;
            } else if (player.quests[n.id] === 1 && finalWord === n.questWord) { alert("You need to find the Quest Item first!"); questTriggered = true; }
        });
        
        if(questTriggered) { isForging = false; btn.innerText = originalBtnText; btn.classList.remove('btn-disabled'); return; }

        let grammarLesson = `Built from <b>${rootOnly}</b>`;
        if(forge.pres.length > 0) grammarLesson += ` with prefix(es) ${forge.pres.join(", ")}`;
        if(forge.sufs.length > 0) grammarLesson += ` and suffix(es) ${forge.sufs.join(", ")}`;
        
        if(teacherMode && ruleLog.length > 0) {
            grammarLesson += `<br><br><b>üìù Rules Applied:</b><ul style='text-align:left; margin:5px 0 0 20px; color:#d35400;'>`;
            ruleLog.forEach(r => grammarLesson += `<li>${r}</li>`);
            grammarLesson += `</ul>`;
        }

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); 

            let response = await fetch('https://api.dictionaryapi.dev/api/v2/entries/en/' + finalWord, { signal: controller.signal });
            
            let isValid = false;
            let definition = "";
            let partOfSpeech = "";

            if(response.ok) {player.focus = Math.min(player.maxFocus, player.focus + 50);
                isValid = true;
                const data = await response.json();
                definition = data[0]?.meanings[0]?.definitions[0]?.definition;
                partOfSpeech = data[0]?.meanings[0]?.partOfSpeech;
            } else {
                if(forge.pres.length === 0 && forge.sufs.length === 1) {
                    let suffix = forge.sufs[0];
                    let allowedPOS = SUFFIX_RULES[suffix]; 

                    if(allowedPOS) {
                        let rootResp = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${rootOnly}`, { signal: controller.signal });
                        if(rootResp.ok) {
                            let rootData = await rootResp.json();
                            let rootMeanings = rootData[0].meanings.map(m => m.partOfSpeech);
                            let match = rootMeanings.find(pos => allowedPOS.includes(pos));
                            
                            if(match) {
                                isValid = true;
                                definition = `A valid ${suffix === 's' ? 'plural/form' : 'form'} of <b>${rootOnly}</b>.`;
                                partOfSpeech = "derivative";
                                grammarLesson += `<br><span style='color:green;font-size:11px;'>(Validated via Grammar: ${rootOnly} is a ${match})</span>`;
                            } else {
                                throw new Error(`Grammar Mismatch: -${suffix} needs a ${allowedPOS.join(' or ')}.`);
                            }
                        }
                    } else {
                         throw new Error(`"${finalWord}" is not in the dictionary.`);
                    }
                }
            }
            
            clearTimeout(timeoutId);

            if(!isValid) throw new Error("Word not found");
            
            let visualHTML = `<span style='color:#0d47a1'>${prefixStr}</span><b>${rootOnly}</b><span style='color:#7b1fa2'>${forge.sufs.join("")}</span>`;
            let titleHtml = `<div style="color:#27ae60; font-weight:bold; font-size:18px;">‚ú® ${finalWord.toUpperCase()}</div><div style="font-size:14px; color:#7f8c8d;">(${visualHTML})</div><small>(${partOfSpeech})</small>`;
            m.innerHTML = `${titleHtml}<div style="font-size:13px; color:#333; margin-top:5px; padding:8px; background:rgba(0,0,0,0.05); border-radius:4px; text-align:left;"><b>Definition:</b> ${definition}</div><div style="font-size:12px; color:#555; margin-top:6px; border-top:1px solid #ddd; padding-top:4px;">${grammarLesson}</div>`;
            
            // NERFED REWARDS
            let bonus = (forge.pres.length + forge.sufs.length) * 2; // Was 5
            if (player.unlocks.doubleFrag) bonus *= 2; 
            let reward = 4 + bonus; // Base reward reduced from 10 to 2
            
            player.fragments += reward; 
            
            // Focus reward also slightly reduced to make food/sleep mechanics relevant later
            player.focus = Math.min(player.maxFocus, player.focus + 30);

        } catch(e) {
            sfx.error();
            if (e.name === 'AbortError') {
                m.innerHTML = `<span style="color:#c0392b; font-weight:bold;">‚ö†Ô∏è Connection Timed Out.</span>`;
            } else if (e.message.includes("Grammar Mismatch")) {
                m.innerHTML = `<span style="color:#c0392b; font-weight:bold;">‚ùå Grammar Error</span><br><span style="font-size:12px;">${e.message}</span>`;
            } else {
                m.innerHTML = `<span style="color:#c0392b; font-weight:bold;">‚ùå "${finalWord}" is not a word.</span>`;
            }
        } finally {
            isForging = false; btn.innerText = originalBtnText; btn.classList.remove('btn-disabled');
        }
    }

    function setActiveBlock(id,n) { player.activeBlock=id; alert("Equipped: "+n); }
    
    function craft(i) {
        if(i==='heal_mud'&&player.resources.dirt>=3) { player.resources.dirt-=3; player.hp=3; alert("Healed!"); }
        else if(i==='wall') {
            // INCREASED COST: Now costs 3 Dirt (was 1) and 2 Fragments (was 1)
            if(player.resources.dirt>=3 && player.fragments>=2) { 
                player.resources.dirt-=3; player.fragments-=2; player.blocks[9]+=5; 
                showToast("Walls Crafted!", "good");
            } else alert("Cost increased! Need 3 Dirt + 2 Fragments.");
        }
        else if(i==='wood') {
            if(player.resources.wood>=2 && player.fragments>=1) {
                player.resources.wood-=2; player.fragments--; player.blocks[4]+=5; showToast("Planks Crafted!", "good");
            } else alert("Need 2 Wood + 1 Fragment!");
        }
        else if(i==='ladder') {
            if(player.resources.wood>=3 && player.fragments>=1) {
                player.resources.wood-=3; player.fragments--; player.blocks[13]+=10; showToast("Ladders Crafted!", "good");
            } else alert("Need 3 Wood + 1 Fragment!");
        }
        else if(i==='stone_brick'&&player.resources.stone>=2) { player.resources.stone-=2; player.blocks[5]+=5; alert("Bricks crafted!"); }
        else if(i==='lantern'&&player.resources.wood>=1&&player.fragments>=1) { player.resources.wood-=1; player.fragments-=1; player.blocks[11]+=3; alert("Lanterns crafted!"); }
        else if(i==='door'&&player.resources.wood>=2&&player.resources.stone>=1) { player.resources.wood-=2; player.resources.stone-=1; if(!player.blocks[6]) player.blocks[6]=0; player.blocks[6]+=3; alert("Doors crafted!"); }
        else if(i==='time_wood'&&player.resources.wood>=3) { player.resources.wood-=3; gameTick+=1800; alert("Campfire burning... Time passed."); }
        else if(i==='arrows'&&player.resources.wood>=1&&player.fragments>=2) { player.resources.wood--; player.fragments-=2; player.arrows+=10; }
        else if(i==='quill'&&player.fragments>=10) { player.fragments-=10; player.hasQuill=true; alert("Golden Quill purchased! (Future Content)"); }
// NEW TOOL RECIPES
        else if(i==='wood_pick') {
            if(player.resources.wood >= 5 && player.fragments >= 5) {
                player.resources.wood -= 5; player.fragments -= 5;
                player.tool = "wood_pick";
                player.toolHp = TOOLS["wood_pick"].maxHp;
                showToast("Crafted Wood Pickaxe!", "good");
            } else alert("Need 5 Wood + 5 Fragments");
        }
        else if(i==='stone_pick') {
            if(player.resources.stone >= 5 && player.resources.wood >= 2 && player.fragments >= 10) {
                player.resources.stone -= 5; player.resources.wood -= 2; player.fragments -= 10;
                player.tool = "stone_pick";
                player.toolHp = TOOLS["stone_pick"].maxHp;
                showToast("Crafted Stone Pickaxe!", "good");
            } else alert("Need 5 Stone + 2 Wood + 10 Fragments");
        }
        updateInvCounts(); renderInventory();
    }
    function updateInvCounts() { document.getElementById('res-frag').innerText=player.fragments; }

    // === SAVE MANAGER ===
    function toggleSaveMenu(forLoading) {
        document.querySelectorAll('.popup').forEach(e=>e.classList.remove('active'));
        document.getElementById('screen-saves').classList.add('active');
        document.getElementById('save-input-area').style.display = forLoading ? 'none' : 'flex';
        renderSaveList(forLoading);
    }
    
    function closeSaveMenu() {
        document.getElementById('screen-saves').classList.remove('active');
        if(state === 'start') document.getElementById('screen-start').classList.add('active');
        else if(state === 'inventory') document.getElementById('screen-inv').classList.add('active');
    }

    function getSaves() { return JSON.parse(localStorage.getItem('wordcraft_v3_saves') || "{}"); }
    
    function renderSaveList(forLoading) {
        let container = document.getElementById('save-list-container');
        container.innerHTML = "";
        let saves = getSaves();
        let keys = Object.keys(saves);
        
        if(keys.length === 0) { container.innerHTML = "<div style='text-align:center; margin-top:50px; color:#777;'>No saved worlds found.</div>"; return; }
        
        keys.forEach(k => {
            let s = saves[k];
            let date = new Date(s.timestamp || Date.now()).toLocaleDateString();
            let div = document.createElement('div');
            div.className = "save-slot-row";
            div.innerHTML = `
                <div class="save-info">
                    <div class="save-title">${k}</div>
                    <div class="save-meta">Fragments: ${s.player.fragments} | Day: ${Math.floor(s.gameTick/3600)} | ${date}</div>
                </div>
                <div class="save-actions">
                    ${forLoading ? `<button class="btn-load" onclick="loadSaveSlot('${k}')">LOAD</button>` : ''}
                    <button class="btn-del" onclick="deleteSaveSlot('${k}', ${forLoading})">DEL</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function doSave() {
        let name = document.getElementById('save-name-input').value.trim();
        if(!name) { alert("Please enter a name!"); return; }
        let saves = getSaves();
        if(saves[name] && !confirm("Overwrite existing save '" + name + "'?")) return;
        saves[name] = { version: VERSION, player: player, grid: grid, enemies: enemies, gameTick: gameTick, timestamp: Date.now() };
        localStorage.setItem('wordcraft_v3_saves', JSON.stringify(saves));
        alert("Saved!"); toggleSaveMenu(false); document.getElementById('save-name-input').value = "";
    }

    function loadSaveSlot(name) {
        let saves = getSaves();
        if(saves[name]) {
            let data = saves[name];
            grid = data.grid; enemies = data.enemies; gameTick = data.gameTick;
            player = { ...player, ...data.player }; 
            player.resources = { ...player.resources, ...data.player.resources };
            player.blocks = { ...player.blocks, ...data.player.blocks };
            player.quests = { ...player.quests, ...data.player.quests };
            player.unlocks = { ...player.unlocks, ...data.player.unlocks };
            setGameState('playing');
        }
    }

    function deleteSaveSlot(name, forLoading) {
        if(confirm("Delete '" + name + "' forever?")) {
            let saves = getSaves();
            delete saves[name];
            localStorage.setItem('wordcraft_v3_saves', JSON.stringify(saves));
            renderSaveList(forLoading);
        }
    }

    function toggleMap() { if(player.unlocks.map) alert("Map Active!"); else alert("Help Elder Bark first."); }
function respawnPlayer() {
        // Reset Position to Surface
        player.x = 20;
        player.y = 10;
        
        // Reset Stats
        player.hp = player.maxHp;
        player.focus = 50; // Give them a little focus back
        player.invinc = 60; // 1 second of invincibility
        
        // Go back to game
        setGameState('playing');
        showToast("Respawned! Inventory Saved.", "good");
    }
    function simKey(k,s) { keys[k]=s; if(s) initAudio(); }
</script>
</body>
</html>
