<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WordCraft v2.2: High Sun Fix</title>
    <style>
        :root { --bg-color: #2c3e50; --ui-border: #5d4037; --accent: #e67e22; }
        body { background-color: var(--bg-color); color: #2c3e50; font-family: 'Verdana', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 0; height: 100vh; overflow: hidden; user-select: none; touch-action: none; }
        
        #game-frame { 
            position: relative; border: 6px solid var(--ui-border); border-radius: 8px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.9); background: #000; 
            cursor: crosshair; width: 100%; max-width: 800px; height: auto; aspect-ratio: 4/3;
        }
        canvas { display: block; image-rendering: pixelated; width: 100%; height: 100%; }
        
        #overlay-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; align-items: center; justify-content: center; z-index: 10; }
        
        .popup { 
            pointer-events: auto; background: #fff; border: 4px solid var(--ui-border); 
            border-radius: 8px; text-align: center; max-width: 95%; max-height: 95%; 
            display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            padding: 0; overflow: hidden; 
            line-height: 1.5 !important; font-size: 14px;
        }
        .popup.active { display: flex; flex-direction: column; animation: popIn 0.2s ease-out; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* START SCREEN */
        .start-box { padding: 25px; display: flex; flex-direction: column; gap: 15px; }
        h1 { margin: 0; color: #c0392b; font-size: 32px; text-shadow: 2px 2px 0 #eee; line-height: 1.2; }
        h3 { margin: 0; color: #555; font-size: 18px; line-height: 1.2; }
        
        /* INVENTORY LAYOUT */
        #screen-inv { width: 700px; height: 550px; background-image: url('assets/bg.png'); background-color: #f3e5f5; background-size: cover; color: #3e2723; }
        .inv-header { padding: 10px; background: rgba(255,255,255,0.95); border-bottom: 3px solid #5d4037; flex-shrink: 0; }
        .inv-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .inv-footer { padding: 10px; background: rgba(255,255,255,0.95); border-top: 3px solid #5d4037; flex-shrink: 0; display: flex; justify-content: center; gap: 15px; }

        .forge-tabs { display: flex; background: rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; }
        .tab { flex: 1; padding: 12px; cursor: pointer; font-weight: bold; background: rgba(255,255,255,0.5); border-right: 1px solid rgba(0,0,0,0.1); transition: 0.2s; font-size: 14px; }
        .tab.active { background: #fff; color: #d35400; box-shadow: inset 0 -3px 0 #d35400; }

        .crafting-grid { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 10px 0; }
        .craft-slot { width: 60px; height: 60px; border: 3px dashed #5d4037; display: flex; align-items: center; justify-content: center; font-weight: bold; background: rgba(255,255,255,0.6); cursor: pointer; border-radius: 8px; font-size: 13px; }
        
        .inv-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; background: rgba(255,255,255,0.4); border-radius: 6px; padding: 10px; min-height: 100px; border: 1px solid rgba(0,0,0,0.1); }
        .inv-body::-webkit-scrollbar { width: 10px; }
        .inv-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .inv-body::-webkit-scrollbar-thumb { background: #8d6e63; border-radius: 5px; }

        .word-chip { background: #fff; border: 2px solid #5d4037; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        .word-chip:active { transform: translateY(2px); box-shadow: none; }
        .chip-pre { background-color: #bbdefb; border-color: #1565c0; color: #0d47a1; } 
        .chip-root { background-color: #c8e6c9; border-color: #2e7d32; color: #1b5e20; }
        .chip-suf { background-color: #e1bee7; border-color: #7b1fa2; color: #4a148c; } 
        
        .craft-row { display: flex; width: 98%; align-items: center; gap: 10px; margin-bottom: 5px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #aaa; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .craft-icon { font-size: 24px; width: 40px; text-align: center; }
        .craft-desc { flex: 1; text-align: left; font-size: 13px; }
        .craft-title { font-weight: bold; color: #2c3e50; display: block; font-size: 15px; margin-bottom: 2px; }
        .craft-cost { font-size: 11px; font-weight: bold; color: #e67e22; background: #fff3e0; padding: 3px 6px; border-radius: 4px; border: 1px solid #ffe0b2; }
        .craft-btn { background: #27ae60; color: white; border: none; padding: 8px 15px; font-size: 13px; font-weight: bold; cursor: pointer; border-radius: 5px; min-width: 70px; box-shadow: 0 2px 0 #1e8449; }
        .craft-btn:active { transform: translateY(2px); box-shadow: none; }
        
        .artifact-item { width: 95%; background: #5d4037; color: #ffecb3; border: 2px solid #3e2723; padding: 10px; margin-bottom: 5px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .salvage-btn { background: #d35400; border:none; padding:8px 15px; color:white; border-radius:5px; cursor:pointer; font-weight:bold; box-shadow: 0 2px 0 #a04000; }
        .salvage-btn:active { transform: translateY(2px); box-shadow: none; }
        
        #resource-bar { display: flex; justify-content: center; gap: 15px; background: #3e2723; color: white; padding: 8px; border-radius: 6px; font-size: 14px; font-weight: bold; border: 2px solid #5d4037; }
        #forge-msg { min-height: 50px; background: #fff8e1; border: 2px solid #d35400; margin: 10px 0; padding: 10px; font-size: 14px; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 6px; color: #d35400; font-weight: bold; }

        /* DIALOGUE & HUD */
        #dialogue-box { position: absolute; bottom: 20px; left: 5%; width: 90%; background: #fff; border: 4px solid #3e2723; padding: 20px; border-radius: 12px; display: none; font-family: 'Courier New', monospace; font-size: 18px; line-height: 1.4; box-shadow: 0 10px 25px rgba(0,0,0,0.5); pointer-events: auto; z-index: 20; box-sizing: border-box; }
        .npc-name { color: #d35400; font-weight: bold; display: block; margin-bottom: 8px; text-transform: uppercase; font-size: 20px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .next-btn { float: right; background: #3e2723; color: white; border: none; padding: 8px 16px; cursor: pointer; margin-top: 15px; font-size: 16px; border-radius: 4px; }

        #mobile-controls { position: absolute; bottom: 10px; left: 0; width: 100%; height: 160px; pointer-events: none; z-index: 5; display: none; }
        .control-group { pointer-events: auto; position: absolute; bottom: 10px; }
        .dpad { left: 20px; width: 120px; height: 120px; position: relative; }
        .actions { right: 20px; display: flex; gap: 15px; align-items: flex-end; }
        .touch-btn { background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 50%; backdrop-filter: blur(4px); color: white; font-size: 24px; display: flex; justify-content: center; align-items: center; user-select: none; touch-action: none; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .touch-btn:active { background: rgba(255, 255, 255, 0.5); transform: scale(0.95); }
        .d-btn { position: absolute; width: 40px; height: 40px; }
        .d-up { top: 0; left: 40px; } .d-down { bottom: 0; left: 40px; } .d-left { top: 40px; left: 0; } .d-right { top: 40px; right: 0; }
        .act-btn { width: 60px; height: 60px; font-size: 28px; } .act-sm { width: 45px; height: 45px; font-size: 20px; margin-bottom: 20px; }

        .toggle-btn { background: #ccc; border-radius: 20px; width: 50px; height: 26px; position: relative; cursor: pointer; transition: 0.3s; display:inline-block; vertical-align:middle; margin-left:10px; border: 1px solid #999; }
        .toggle-btn.on { background: #27ae60; border-color: #1e8449; }
        .toggle-btn.on::after { left: 26px; }
        .toggle-btn::after { content:''; position: absolute; left: 2px; top: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        
        .save-btn { background: #8e44ad; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; box-shadow: 0 3px 0 #6c3483; }
        .save-btn:active { transform: translateY(3px); box-shadow: none; }
        .close-btn { background: #c0392b; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; box-shadow: 0 3px 0 #922b21; }
        .close-btn:active { transform: translateY(3px); box-shadow: none; }
    </style>
</head>
<body>
    <div id="game-frame">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="loading" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white; font-family:monospace;">Forging World...</div>

        <div id="dialogue-box">
            <span class="npc-name">NPC</span>
            <div id="dialogue-text">...</div>
            <button class="next-btn" onclick="advanceDialogue()">Next ‚ñ∂</button>
        </div>

        <div id="mobile-controls">
            <div class="control-group dpad">
                <div class="touch-btn d-btn d-up" ontouchstart="simKey('ArrowUp', true)" ontouchend="simKey('ArrowUp', false)">‚¨ÜÔ∏è</div>
                <div class="touch-btn d-btn d-down" ontouchstart="simKey('ArrowDown', true)" ontouchend="simKey('ArrowDown', false)">‚¨áÔ∏è</div>
                <div class="touch-btn d-btn d-left" ontouchstart="simKey('ArrowLeft', true)" ontouchend="simKey('ArrowLeft', false)">‚¨ÖÔ∏è</div>
                <div class="touch-btn d-btn d-right" ontouchstart="simKey('ArrowRight', true)" ontouchend="simKey('ArrowRight', false)">‚û°Ô∏è</div>
            </div>
            <div class="control-group actions">
                <div class="touch-btn act-btn act-sm" ontouchstart="setGameState('inventory')" style="background:rgba(200,100,0,0.4)">üéí</div>
                <div class="touch-btn act-btn act-sm" ontouchstart="interact()" style="background:rgba(100,200,255,0.4)">üí¨</div>
                <div class="touch-btn act-btn" ontouchstart="shootArrow()" style="background:rgba(0,100,200,0.4)">üèπ</div>
                <div class="touch-btn act-btn" ontouchstart="action()" style="background:rgba(200,50,50,0.4)">‚õèÔ∏è</div>
            </div>
        </div>

        <div id="overlay-layer">
            <div id="screen-start" class="popup active">
                <div class="start-box">
                    <div>
                        <h1>WordCraft</h1>
                        <h3>Quest for Meaning</h3>
                    </div>
                    <div style="text-align: left; background: #fff3e0; padding: 20px; border-radius: 8px; font-size: 15px; border:2px solid #ffe0b2;">
                        <p><b>‚ú® Update v2.2:</b></p>
                        <ul style="padding-left:20px; margin:10px 0;">
                            <li><b>Fix:</b> Sun & Moon now arc high in the sky.</li>
                            <li><b>Day/Night:</b> Monsters sleep in sun, hunt in dark.</li>
                            <li><b>Balanced:</b> Fewer monsters in the sky area.</li>
                        </ul>
                        <div style="margin-top:15px; font-weight:bold; cursor:pointer; display:flex; align-items:center;" onclick="toggleMobileControls()">
                            üì± Enable Mobile Controls: <div class="toggle-btn" id="mob-toggle"></div>
                        </div>
                    </div>
                    <div style="display:flex; gap:15px; justify-content:center; margin-top:10px;">
                        <button id="btn-continue" onclick="loadGame()" style="display:none; background:#27ae60; color:white; border:none; padding:15px 30px; font-size:18px; border-radius:6px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 0 #1e8449;">Resume</button>
                        <button onclick="initAudio(); setGameState('playing')" style="background:#d35400; color:white; border:none; padding:15px 30px; font-size:18px; border-radius:6px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 0 #a04000;">New Game</button>
                    </div>
                </div>
            </div>
            
            <div id="screen-death" class="popup" style="justify-content:center; padding: 30px;">
                <h1 style="color:red; margin-bottom:20px;">Scrambled!</h1>
                <p style="margin-bottom:20px;">The Letter Bugs got you.</p>
                <button onclick="location.reload()" style="background:#c0392b; color:white; padding:12px 25px; border:none; border-radius:6px; cursor:pointer; font-size:16px;">Respawn</button>
            </div>

            <div id="screen-inv" class="popup">
                <div class="inv-header">
                    <div class="forge-tabs">
                        <div class="tab active" onclick="switchTab('word')">Word Forge</div>
                        <div class="tab" onclick="switchTab('salvage')">Salvage</div>
                        <div class="tab" onclick="switchTab('craft')">Craft</div>
                    </div>
                    <div id="resource-bar" style="margin-top:10px;">
                        <span>üíé: <span id="res-frag">0</span></span>
                        <span>üü´: <span id="res-dirt">0</span></span>
                        <span>üåë: <span id="res-stone">0</span></span>
                        <span>ü™µ: <span id="res-wood">0</span></span>
                    </div>
                </div>

                <div class="inv-body">
                    <div id="tab-word" style="display:flex; flex-direction:column;">
                        <div class="crafting-grid">
                            <div id="slot-pre" class="craft-slot" onclick="clearSlot('pre')">[Pre]</div> +
                            <div id="slot-root" class="craft-slot" onclick="clearSlot('root')">[ROOT]</div> +
                            <div id="slot-suf" class="craft-slot" onclick="clearSlot('suf')">[Suf]</div>
                            <button onclick="forgeWord()" style="height:60px; background:#27ae60; border:none; color:white; border-radius:8px; font-weight:bold; cursor:pointer; margin-left:10px; font-size:20px; width:60px;">üî®</button>
                        </div>
                        <div id="forge-msg">Drag items here to forge!<br>Words earn üíé Gems.</div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <div style="flex:1;">
                                <small style="background:#a1887f; color:white; padding:4px 8px; border-radius:4px; font-weight:bold;">ROOTS</small>
                                <div id="list-roots" class="inv-grid"></div>
                            </div>
                            <div style="flex:1;">
                                <small style="background:#90caf9; color:#0d47a1; padding:4px 8px; border-radius:4px; font-weight:bold;">AFFIXES</small>
                                <div id="list-affixes" class="inv-grid"></div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-salvage" style="display:none; flex-direction:column; align-items:center;">
                        <div style="text-align:center; margin-bottom:10px;">
                            <h3 style="margin:0; color:#5d4037;">ü™ö Salvage Station</h3>
                            <p style="font-size:13px; margin:5px 0;">Break artifacts to find rare word parts!</p>
                        </div>
                        <div id="list-artifacts" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
                    </div>

                    <div id="tab-craft" style="display:none; flex-direction:column;">
                        <div class="craft-row" style="background:#e8f5e9; border:1px solid #a5d6a7;">
                            <div class="craft-icon">üíä</div><div class="craft-desc"><span class="craft-title">Mud Poultice</span><span class="craft-cost">3 Dirt</span></div>
                            <button class="craft-btn" onclick="craft('heal_mud')">Craft</button>
                        </div>
                         <div class="craft-row" style="background:#fff3e0; border:1px solid #ffcc80;">
                            <div class="craft-icon">üî•</div><div class="craft-desc"><span class="craft-title">Campfire</span><span class="craft-cost">3 Wood</span></div>
                            <button class="craft-btn" onclick="craft('time_wood')">Craft</button>
                        </div>
                        
                        <div class="craft-row" style="background:#f3e5f5; border:1px solid #ce93d8;">
                            <div class="craft-icon">üö™</div>
                            <div class="craft-desc" onclick="setActiveBlock(6, 'Magic Door')" style="cursor:pointer;">
                                <span class="craft-title">Magic Door x3</span>
                                <span class="craft-cost">2 Wood + 1 Stone</span>
                            </div>
                            <button class="craft-btn" onclick="craft('door')">Make</button>
                        </div>

                        <hr style="width:100%; border:1px solid #ddd; margin: 15px 0;">
                        <div style="font-size:12px; color:#999; text-transform:uppercase; font-weight:bold; margin-bottom:8px;">Building Blocks (Click Name to Equip)</div>
                        <div class="craft-row"><div class="craft-icon">üß±</div><div class="craft-desc" onclick="setActiveBlock(9, 'Dirt Wall')" style="cursor:pointer;"><span class="craft-title">Dirt Wall x5</span><span class="craft-cost">1 Dirt</span></div><button class="craft-btn" onclick="craft('wall')">Make</button></div>
                        <div class="craft-row"><div class="craft-icon">ü™µ</div><div class="craft-desc" onclick="setActiveBlock(4, 'Plank')" style="cursor:pointer;"><span class="craft-title">Planks x5</span><span class="craft-cost">2 Wood</span></div><button class="craft-btn" onclick="craft('wood')">Make</button></div>
                        <div class="craft-row"><div class="craft-icon">üèπ</div><div class="craft-desc"><span class="craft-title">Arrows x10</span><span class="craft-cost">2 Gem + 1 Wood</span></div><button class="craft-btn" onclick="craft('arrows')">Make</button></div>
                         <div class="craft-row"><div class="craft-icon">‚úíÔ∏è</div><div class="craft-desc"><span class="craft-title">Golden Quill</span><span class="craft-cost">10 Gem</span></div><button class="craft-btn" onclick="craft('quill')">Buy</button></div>
                    </div>
                </div>

                <div class="inv-footer">
                     <button class="save-btn" onclick="saveGame()">üíæ Save</button>
                     <button class="close-btn" onclick="setGameState('playing')">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div style="color:#aaa; font-size:12px; margin-top:5px; text-align:center;">Keys: Arrows to Move | Space/T to Interact | F to Shoot | B to Build | I for Inventory</div>

<script>
    const VERSION = 2.2;
    const CHAR_SCALE = 1.8; 
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
    const sfx = { playTone: (f,t,d,v=0.1) => { if(!audioCtx) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=t; o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+d); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d); }, jump:()=>sfx.playTone(300,'sine',0.2), mine:()=>sfx.playTone(100,'square',0.1), shoot:()=>sfx.playTone(600,'sawtooth',0.1), build:()=>sfx.playTone(200,'triangle',0.1), collect:()=>sfx.playTone(800,'sine',0.3), hit:()=>sfx.playTone(150,'sawtooth',0.3), craft:()=>sfx.playTone(500,'square',0.5), quest:()=>sfx.playTone(600,'triangle',0.6) };

    const assets = { tiles: new Image(), chars: new Image(), ui: new Image() };
    const processedAssets = { tiles: null, chars: null, ui: null };
    let loadedCount=0, useFallbackAssets=false;
    function onAssetLoad() { loadedCount++; if(loadedCount===3) processAssets(); }
    function onAssetError() { console.warn("Using fallback assets."); useFallbackAssets=true; loadedCount++; if(loadedCount===3) processAssets(); }
    function removeWhite(img) { const c=document.createElement('canvas'); const x=c.getContext('2d'); c.width=img.width; c.height=img.height; x.drawImage(img,0,0); const d=x.getImageData(0,0,c.width,c.height); for(let i=0;i<d.data.length;i+=4) { if(d.data[i]>240&&d.data[i+1]>240&&d.data[i+2]>240) d.data[i+3]=0; } x.putImageData(d,0,0); return c; }
    function processAssets() { 
        if(!useFallbackAssets) { processedAssets.tiles=removeWhite(assets.tiles); processedAssets.chars=removeWhite(assets.chars); processedAssets.ui=removeWhite(assets.ui); } 
        document.getElementById('loading').style.display='none'; 
        if(localStorage.getItem('wordcraft_save')) document.getElementById('btn-continue').style.display='inline-block'; 
        initGame(); 
    }
    assets.tiles.src='assets/tiles.png'; assets.tiles.onload=onAssetLoad; assets.tiles.onerror=onAssetError;
    assets.chars.src='assets/chars.png'; assets.chars.onload=onAssetLoad; assets.chars.onerror=onAssetError;
    assets.ui.src='assets/ui.png'; assets.ui.onload=onAssetLoad; assets.ui.onerror=onAssetError;

    const TILE_SIZE=40, COLS=600, ROWS=150, CANVAS_W=800, CANVAS_H=600;
    const canvas=document.getElementById('gameCanvas'); const ctx=canvas.getContext('2d');
    canvas.width=CANVAS_W; canvas.height=CANVAS_H;
    
    // TIME SETTINGS
    const DAY_LENGTH=3600;
    const NIGHT_THRESHOLD = 0.5; // When CP drops below this, it is night
    let gameTick=0, camera={x:0,y:0}, keys={}, mouse={x:0,y:0};
    let flashAlpha = 0;

    const LAYER_ROOTS={1:["play","help","walk","look"], 2:["happy","cycle","form","port"], 3:["struct","ject","rupt","phon"], 12:["sand","dry","sun","hot"]};
    const LAYER_AFFIXES={1:[{val:"s",type:"suf"},{val:"ed",type:"suf"},{val:"ing",type:"suf"}], 2:[{val:"un",type:"pre"},{val:"re",type:"pre"},{val:"ly",type:"suf"}], 3:[{val:"sub",type:"pre"},{val:"tion",type:"suf"},{val:"ment",type:"suf"}], 12:[{val:"ness",type:"suf"},{val:"less",type:"suf"}]};
    
    const NPCS = [
        { 
            id: "bark", name: "Elder Bark", x: 25, y: 10, spriteRow: 1, 
            intro: ["Greetings, little one.", "My roots are weak.", "First, find the ANCIENT SEED.", "Dig in the dirt to find it."], 
            questId: "bark", questWord: "replant" 
        },
        { 
            id: "rusty", name: "Rusty", x: 40, y: 55, spriteRow: 2, 
            intro: ["Bzzz... Systems offline.", "I need a GEAR.", "Dig deep in stone to find it."], 
            questId: "rusty", questWord: "reconstruct" 
        }
    ];
    
    const ARTIFACTS = [
        { name: "Mossy Spade", word: "REPLANTING", parts: [{t:'pre',v:'re'}, {t:'root',v:'plant'}, {t:'suf',v:'ing'}], desc: "Old tool." },
        { name: "Broken Gear", word: "RECONSTRUCTION", parts: [{t:'pre',v:'re'}, {t:'root',v:'struct'}, {t:'suf',v:'tion'}], desc: "Rusty part." },
        { name: "Stone Tablet", word: "UNCOVERED", parts: [{t:'pre',v:'un'}, {t:'root',v:'cover'}, {t:'suf',v:'ed'}], desc: "Ancient text." }
    ];
    
    let state='start', grid=[], enemies=[], particles=[], projectiles=[], animTick=0;
    let player={ x:20, y:10, hp:3, maxHp:3, fragments:0, resources:{dirt:0,sand:0,stone:0,wood:0,obsidian:0}, roots:[], affixes:[], artifacts:[], hasQuill:false, invinc:0, facingLeft:false, blocks:{9:5,4:0,5:0,11:0,6:0}, arrows:0, activeBlock:9, 
    quests:{bark:0, rusty:0}, unlocks:{map:false, drill:false} };
    let forge={pre:null,root:null,suf:null};
    let currentDialogue = null;

    function initGame() {
        grid=[];
        for(let r=0; r<ROWS; r++){
            let row=[];
            for(let c=0; c<COLS; c++){
                let s = 10 + Math.floor(Math.sin(c*0.05)*5);
                let isCave = (r>s+8) && (Math.random()<0.12);
                if(r<s) row.push(0); else if(isCave) row.push(0); else if(r<s+5) row.push(1); else if(r<s+15) row.push(12); else if(r<s+60) row.push(2); else row.push(3);
            }
            grid.push(row);
        }
        
        // BALANCED SPAWNING LOGIC
        for(let r=5; r<ROWS-5; r++) {
            for(let c=0; c<COLS; c++) {
                if(grid[r][c]===0) {
                     // Drastically reduced Sky Spawn Rate (0.2%) vs Cave (1.5%)
                     let chance = (r < 20) ? 0.002 : 0.015;
                     if(Math.random() < chance) {
                        enemies.push({
                            x:c, y:r, 
                            type: Math.random()>.5?'bat':'slime', 
                            hp:2, speed:15, stun:0
                        });
                     }
                }
            }
        }
        
        let gy=0; while(gy<ROWS && grid[gy][20]===0) gy++; player.y=gy-1;
        
        NPCS.forEach(n => {
            if(n.id === 'bark') { let s = 10 + Math.floor(Math.sin(n.x*0.05)*5); n.y = s - 1; }
            if(n.id === 'rusty') { grid[n.y][n.x] = 0; grid[n.y-1][n.x] = 0; if(grid[n.y+1][n.x] === 0) grid[n.y+1][n.x] = 5; }
        });
        requestAnimationFrame(loop);
    }

    function loop() { if(state==='playing') update(); draw(); requestAnimationFrame(loop); }

    function update() {
        animTick++; gameTick++; if(player.invinc>0) player.invinc--;
        let tX=(player.x*TILE_SIZE)-(CANVAS_W/2), tY=(player.y*TILE_SIZE)-(CANVAS_H/2);
        camera.x=Math.max(0,Math.min(tX,(COLS*TILE_SIZE)-CANVAS_W)); camera.y=Math.max(0,Math.min(tY,(ROWS*TILE_SIZE)-CANVAS_H));

        // DAY/NIGHT LOGIC
        let tod=gameTick%DAY_LENGTH; 
        // 0-1800 is Day, 1800-3600 is Night for this Sine wave logic
        let cp=Math.sin((tod/DAY_LENGTH)*Math.PI);
        let isNight = tod > (DAY_LENGTH * 0.5); // Simple: Second half of cycle is Night

        enemies.forEach((en,i)=>{
            if(en.stun>0) { en.stun--; return; }
            
            // SLEEP LOGIC: If it is NOT night, enemies don't move
            if(!isNight) {
                // Occasionally add a Zzz particle
                if(Math.random() < 0.02) addPart(en.x, en.y-1, "z", "#888");
                return; // SKIP MOVEMENT
            }

            if(Math.abs(en.x-player.x)<30 && Math.abs(en.y-player.y)<20) {
                if(animTick%en.speed===0) {
                    let nx=en.x, ny=en.y;
                    if(en.x<player.x) nx++; else if(en.x>player.x) nx--; else if(en.y<player.y) ny++; else if(en.y>player.y) ny--;
                    
                    if(grid[ny][nx]===0) { en.x=nx; en.y=ny; }
                }
                if(en.x===player.x && en.y===player.y) hurtPlayer();
            }
        });
        
        for(let i=projectiles.length-1; i>=0; i--) {
            let p=projectiles[i]; p.x+=p.vx; p.y+=p.vy;
            let gx=Math.round(p.x), gy=Math.round(p.y), hit=false;
            enemies.forEach((en,ei)=>{ if(Math.round(en.x)===gx && Math.round(en.y)===gy) { en.hp--; hit=true; sfx.hit(); if(en.hp<=0) {enemies.splice(ei,1); player.fragments+=3;} } });
            if(gx<0||gx>=COLS||gy<0||gy>=ROWS||(grid[gy][gx]!==0)||hit) projectiles.splice(i,1);
        }
        for(let i=particles.length-1; i>=0; i--) { particles[i].life--; particles[i].y-=0.5; if(particles[i].life<=0) particles.splice(i,1); }
    }

    document.addEventListener('keydown', e=>{
        if(e.key===' ') e.preventDefault();
        keys[e.key]=true;
        if(state!=='playing') return;
        let dx=0, dy=0;
        if(e.key==='ArrowLeft') { dx=-1; player.facingLeft=true; } if(e.key==='ArrowRight') { dx=1; player.facingLeft=false; }
        if(e.key==='ArrowUp') dy=-1; if(e.key==='ArrowDown') dy=1;
        if(dx!==0||dy!==0) { 
            let nx=player.x+dx, ny=player.y+dy; 
            if(nx>=0&&nx<COLS&&ny>=0&&ny<ROWS && (grid[ny][nx]===0 || grid[ny][nx]===6)) { 
                player.x=nx; player.y=ny; 
            } 
        }
        if(e.key===' ') interact();
        if(e.key==='f'||e.key==='F') shootArrow();
        if(e.key==='i'||e.key==='I') setGameState('inventory');
        if(e.key==='b'||e.key==='B') placeBlock();
        if(e.key==='t'||e.key==='T') interact();
        if(e.key==='m'||e.key==='M') toggleMap();
    });
    document.addEventListener('keyup', e=>{ keys[e.key]=false; });

    function toggleMobileControls() {
        let el = document.getElementById('mobile-controls');
        let btn = document.getElementById('mob-toggle');
        let isOn = btn.classList.contains('on');
        if(isOn) { el.style.display = 'none'; btn.classList.remove('on'); } 
        else { el.style.display = 'block'; btn.classList.add('on'); }
    }

    function interact() {
        let talked = false;
        NPCS.forEach(n => {
            if(Math.abs(player.x - n.x) <= 1.5 && Math.abs(player.y - n.y) <= 1.5) {
                startDialogue(n); talked = true;
            }
        });
        if(talked) return;
        action();
    }

    function startDialogue(npc) {
        let box = document.getElementById('dialogue-box');
        let text = document.getElementById('dialogue-text');
        box.style.display = 'block';
        document.querySelector('.npc-name').innerText = npc.name;
        
        let qState = player.quests[npc.id];
        let lines = [];
        
        if(npc.id === 'bark') {
            if(qState === 3) lines = ["The forest is safe now.", "Use the Map I gave you."];
            else if(qState === 2) lines = ["You found the Seed!", "Now use the Forge to make REPLANT."];
            else if(qState === 1) lines = ["Have you found the seed?", "Check the Dirt layers."];
            else { lines = npc.intro; player.quests[npc.id] = 1; alert("Quest Started: Find the Seed!"); }
        } else if(npc.id === 'rusty') {
             if(qState === 3) lines = ["Systems optimized.", "The Drill is yours."];
            else if(qState === 2) lines = ["Gear acquired.", "Forge RECONSTRUCT to fix me."];
            else if(qState === 1) lines = ["I need the Gear...", "It is in the Stone."];
            else { lines = npc.intro; player.quests[npc.id] = 1; alert("Quest Started: Find the Gear!"); }
        }
        
        currentDialogue = { lines: lines, index: 0 };
        text.innerText = lines[0];
    }
    
    function advanceDialogue() {
        if(!currentDialogue) return;
        currentDialogue.index++;
        if(currentDialogue.index < currentDialogue.lines.length) {
            document.getElementById('dialogue-text').innerText = currentDialogue.lines[currentDialogue.index];
        } else {
            document.getElementById('dialogue-box').style.display = 'none';
            currentDialogue = null;
        }
    }

    function action() {
        let tx=player.x, ty=player.y;
        if(keys['ArrowUp']) ty--; else if(keys['ArrowDown']) ty++; else if(keys['ArrowLeft']) tx--; else if(keys['ArrowRight']) tx++; else { tx+=(player.facingLeft?-1:1); if(grid[ty][tx]===0) ty++; }
        if(tx>=0&&tx<COLS&&ty>=0&&ty<ROWS) {
            let t=grid[ty][tx];
            if(t>0) {
                if(t===6 && !keys['b']) return; 
                grid[ty][tx]=0; sfx.mine(); addPart(tx,ty,"‚ú®");
                let gain = player.unlocks.drill ? 2 : 1;
                if(t===1) player.resources.dirt+=gain; else if(t===12) player.resources.sand+=gain; else if(t===2) player.resources.stone+=gain; else if(t===3) player.resources.obsidian+=gain; else if(t===6) { player.blocks[6]++; alert("Door recovered"); }
                
                let foundSpecial = false;
                if(player.quests.bark === 1 && t === 1 && Math.random() < 0.15) { 
                     player.quests.bark = 2; 
                     addPart(player.x, player.y-1, "üå∞", "lightgreen"); 
                     alert("You found the ANCIENT SEED!"); sfx.quest(); foundSpecial = true;
                }
                else if(player.quests.rusty === 1 && t === 2 && Math.random() < 0.15) { 
                     player.quests.rusty = 2; 
                     addPart(player.x, player.y-1, "‚öôÔ∏è", "gray"); 
                     alert("You found the RUSTY GEAR!"); sfx.quest(); foundSpecial = true;
                }

                if(!foundSpecial && Math.random() < 0.6) {
                    if(Math.random() < 0.1) { 
                        let a=ARTIFACTS[Math.floor(Math.random()*ARTIFACTS.length)]; 
                        player.artifacts.push(a); addPart(player.x,player.y-1,"üéÅ","gold"); sfx.collect(); 
                    } else {
                         let l=LAYER_ROOTS[t]||["root"]; 
                         player.roots.push({word:l[Math.floor(Math.random()*l.length)],type:t}); addPart(player.x,player.y-1,"üìú");
                    }
                }
            }
        }
    }
    
    function placeBlock() { let id=player.activeBlock; if(player.blocks[id]>0 && grid[player.y][player.x]===0) { grid[player.y][player.x]=id; player.blocks[id]--; sfx.build(); } }
    function shootArrow() { if(player.arrows>0) { player.arrows--; projectiles.push({x:player.x,y:player.y,vx:(player.facingLeft?-1:1),vy:0}); sfx.shoot(); } }
    function addPart(x,y,c,cl="white") { particles.push({x:x,y:y,char:c,color:cl,life:30}); }
    function hurtPlayer() { if(player.invinc>0) return; player.hp--; player.invinc=30; sfx.hit(); if(player.hp<=0) setGameState('death'); }

    function draw() {
        let tod=gameTick%DAY_LENGTH; 
        // DAY/NIGHT COLOR MATH
        let cp = Math.sin((tod / DAY_LENGTH) * Math.PI); 
        
        let r,g,b;
        if(tod < DAY_LENGTH * 0.5) {
             r=135; g=206; b=235; // Day Blue
        } else {
             r=20; g=20; b=60; // Night Blue
        }
        r = Math.floor(135 * cp + 20 * (1-cp));
        g = Math.floor(206 * cp + 20 * (1-cp));
        b = Math.floor(235 * cp + 60 * (1-cp));

        ctx.fillStyle=`rgb(${r},${g},${b})`; ctx.fillRect(0,0,CANVAS_W,CANVAS_H);

        // --- SUN/MOON POSITION FIX ---
        // Center of rotation is now (CANVAS_H + 400) = 1000
        // Radius is 800
        // Top of arc is 1000 - 800 = 200 (pixels from top).
        let cx = CANVAS_W/2 + Math.cos((tod/DAY_LENGTH) * Math.PI * 2 + Math.PI) * 800;
        let cy = (CANVAS_H + 400) + Math.sin((tod/DAY_LENGTH) * Math.PI * 2 + Math.PI) * 800;
        
        ctx.fillStyle = (tod < DAY_LENGTH*0.5) ? "yellow" : "white";
        ctx.beginPath(); ctx.arc(cx, cy, 40, 0, Math.PI*2); ctx.fill();

        let tW=useFallbackAssets?TILE_SIZE:processedAssets.tiles.width; 
        let tH=useFallbackAssets?TILE_SIZE:processedAssets.tiles.height/5;
        let cX=Math.floor(camera.x/TILE_SIZE), cY=Math.floor(camera.y/TILE_SIZE);
        let eX=cX+(CANVAS_W/TILE_SIZE)+1, eY=cY+(CANVAS_H/TILE_SIZE)+1;

        ctx.save(); ctx.translate(-camera.x, -camera.y);

        for(let r=cY; r<=eY; r++){
            for(let c=cX; c<=eX; c++){
                if(r>=0 && r<ROWS && c>=0 && c<COLS) {
                    let t=grid[r][c];
                    if(player.unlocks.map && t>0) ctx.globalAlpha = 0.5; 
                    if(t>0) {
                         if(useFallbackAssets) { ctx.fillStyle=t===6?"purple":"brown"; ctx.fillRect(c*TILE_SIZE,r*TILE_SIZE,TILE_SIZE,TILE_SIZE); }
                         else {
                             if(t===6) { // Draw Door
                                 ctx.fillStyle="#9b59b6"; ctx.fillRect(c*TILE_SIZE,r*TILE_SIZE,TILE_SIZE,TILE_SIZE);
                                 ctx.strokeStyle="#8e44ad"; ctx.lineWidth=3; ctx.strokeRect(c*TILE_SIZE,r*TILE_SIZE,TILE_SIZE,TILE_SIZE);
                             } else {
                                 let tidx = (t<=3) ? t-1 : (t===12?0:(t===9?3:0));
                                 ctx.drawImage(processedAssets.tiles, tW*0.4, (tidx*tH)+tH*0.2, tW*0.2, tH*0.6, c*TILE_SIZE, r*TILE_SIZE, TILE_SIZE+1, TILE_SIZE+1);
                             }
                         }
                    }
                    ctx.globalAlpha = 1.0;
                }
            }
        }
        
        NPCS.forEach(n => {
            ctx.textBaseline = "top"; ctx.font = "30px Arial"; ctx.fillText(n.id==='bark'?"üå≥":"ü§ñ", n.x*TILE_SIZE, n.y*TILE_SIZE);
            if(Math.abs(player.x - n.x) < 3 && Math.abs(player.y - n.y) < 3) { ctx.font = "14px Arial"; ctx.fillStyle = "white"; ctx.fillText("PRESS T", n.x*TILE_SIZE-10, n.y*TILE_SIZE-20); }
        });
        ctx.textBaseline = "alphabetic";

        if(!useFallbackAssets) {
            let cW=processedAssets.chars.width/3, cH=processedAssets.chars.height/3;
            let drawSize = TILE_SIZE * CHAR_SCALE;
            let offset = (drawSize - TILE_SIZE) / 2;

            ctx.save(); 
            // Draw Player
            if(player.facingLeft) { 
                ctx.translate((player.x*TILE_SIZE)+TILE_SIZE, player.y*TILE_SIZE); 
                ctx.scale(-1,1); 
                ctx.drawImage(processedAssets.chars, (Math.floor(animTick/20)%2)*cW, 0, cW, cH, -offset, -offset, drawSize, drawSize); 
            } else { 
                ctx.drawImage(processedAssets.chars, (Math.floor(animTick/20)%2)*cW, 0, cW, cH, (player.x*TILE_SIZE)-offset, (player.y*TILE_SIZE)-offset, drawSize, drawSize); 
            }
            ctx.restore();
            
            // Draw Enemies
            enemies.forEach(en=>{ 
                ctx.drawImage(processedAssets.chars, (Math.floor(animTick/10)%3)*cW, (en.type==='bat'?1:2)*cH, cW, cH, (en.x*TILE_SIZE)-offset, (en.y*TILE_SIZE)-offset, drawSize, drawSize); 
            });
        }
        
        ctx.fillStyle="yellow"; projectiles.forEach(p=>ctx.fillRect(p.x*TILE_SIZE,p.y*TILE_SIZE,5,5));
        ctx.font="20px Arial"; particles.forEach(p=>{ctx.fillStyle=p.color; ctx.fillText(p.char,p.x*TILE_SIZE,p.y*TILE_SIZE)});
        ctx.restore();

        if(flashAlpha > 0) {
            ctx.fillStyle = `rgba(255, 215, 0, ${flashAlpha})`;
            ctx.fillRect(0,0,CANVAS_W, CANVAS_H);
            flashAlpha -= 0.02; 
        }

        ctx.fillStyle="white"; ctx.font="bold 20px Verdana"; ctx.fillText(player.fragments, 100, 30);
        ctx.font="14px Verdana"; ctx.fillText(player.unlocks.drill?"Drill Active!":"Pickaxe", 10, 50);
        
        let isNight = tod > (DAY_LENGTH * 0.5);
        ctx.fillText(isNight ? "üåô Night" : "‚òÄÔ∏è Day", 10, 70);
    }
    
    function setGameState(s) { 
        state=s; 
        document.querySelectorAll('.popup').forEach(e=>e.classList.remove('active')); 
        if(s==='start')document.getElementById('screen-start').classList.add('active'); 
        if(s==='inventory'){
            document.getElementById('screen-inv').classList.add('active');
            renderInventory(); 
        } 
        if(s==='playing') initAudio(); 
    }

    function switchTab(t) { 
        document.getElementById('tab-word').style.display=t==='word'?'flex':'none'; 
        document.getElementById('tab-craft').style.display=t==='craft'?'flex':'none'; 
        document.getElementById('tab-salvage').style.display=t==='salvage'?'flex':'none'; 
        if(t==='salvage') renderSalvage(); 
        else renderInventory(); 
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')); 
        event.target.classList.add('active'); 
    }

    function renderInventory() { 
        let d=document.getElementById('list-roots'); d.innerHTML=""; 
        if(player.roots.length===0) d.innerHTML="<small>Empty. Go Dig!</small>";
        else player.roots.forEach(r => { 
            let s = document.createElement('div'); 
            s.className="word-chip chip-root"; 
            s.innerText=r.word; 
            s.onclick=()=>setSlot('root',r.word); d.appendChild(s); 
        });

        let da=document.getElementById('list-affixes'); da.innerHTML="";
        if(player.affixes.length===0) da.innerHTML="<small>Empty.</small>";
        else player.affixes.forEach(a => {
            let s = document.createElement('div'); 
            let typeClass = (a.type==="pre") ? "chip-pre" : "chip-suf";
            s.className=`word-chip ${typeClass}`; 
            let displayVal = (a.type==="pre") ? a.val+"-" : "-"+a.val;
            s.innerText=displayVal;
            s.onclick=()=>setSlot(a.type, a.val); 
            da.appendChild(s);
        });
        
        document.getElementById('res-frag').innerText = player.fragments;
        document.getElementById('res-dirt').innerText = player.resources.dirt;
        document.getElementById('res-stone').innerText = player.resources.stone;
        document.getElementById('res-wood').innerText = player.resources.wood;
    }

    function renderSalvage() { 
        let d=document.getElementById('list-artifacts'); d.innerHTML=""; 
        if(player.artifacts.length===0) d.innerHTML="<div style='padding:20px'>Go mine!</div>";
        player.artifacts.forEach((a,i)=>{ d.innerHTML+=`<div class='artifact-item'><div><div class='artifact-word'>${a.word}</div><div style='font-size:10px;color:#f1c40f'>${a.desc}</div></div><button class='salvage-btn' onclick='salvageItem(${i},this)'>BREAK</button></div>`; });
    }

    function salvageItem(i,btn) {
        if(!player.artifacts[i]) return;
        btn.parentElement.classList.add('break-anim'); sfx.mine();
        setTimeout(()=>{
            let it=player.artifacts[i]; 
            let gotList = [];
            it.parts.forEach(p=>{ 
                if(p.t==='root') player.roots.push({word:p.v,type:1}); 
                else player.affixes.push({val:p.v,type:p.t}); 
                gotList.push(p.v);
            });
            player.artifacts.splice(i,1); player.fragments+=5;
            alert("Salvaged: " + it.word + "\nReceived: " + gotList.join(", "));
            renderSalvage(); renderInventory();
        },400);
    }
    
    async function forgeWord() {
        if(!forge.root) return;
        let m=document.getElementById('forge-msg'); m.innerHTML="Checking..."; sfx.craft();
        let w = ((forge.pre||"") + forge.root + (forge.suf||"")).toLowerCase();
        
        let questTriggered = false;
        NPCS.forEach(n => {
            if(player.quests[n.id] === 2 && w === n.questWord) {
                player.quests[n.id] = 3; 
                if(n.id === 'bark') player.unlocks.map = true;
                if(n.id === 'rusty') player.unlocks.drill = true;
                flashAlpha = 1.0;
                alert(`QUEST COMPLETE: Reward Unlocked!`); sfx.quest();
                questTriggered = true;
            } else if (player.quests[n.id] === 1 && w === n.questWord) {
                alert("You need to find the Quest Item first!");
                questTriggered = true; 
            }
        });
        
        m.innerHTML = `<span style="color:green">‚ú® ${w.toUpperCase()}</span>`;
        player.fragments+=10; sfx.collect();
        let rIdx = player.roots.findIndex(r => r.word === forge.root);
        if(rIdx > -1) player.roots.splice(rIdx, 1);
        if(forge.pre) { let pIdx = player.affixes.findIndex(a => a.val === forge.pre && a.type === "pre"); if(pIdx > -1) player.affixes.splice(pIdx, 1); }
        if(forge.suf) { let sIdx = player.affixes.findIndex(a => a.val === forge.suf && a.type === "suf"); if(sIdx > -1) player.affixes.splice(sIdx, 1); }

        forge={pre:null,root:null,suf:null}; document.getElementById('slot-pre').innerText="[Pre]"; document.getElementById('slot-root').innerText="[Root]"; document.getElementById('slot-suf').innerText="[Suf]";
        renderInventory();
    }

    function setSlot(t,v) { forge[t]=v; document.getElementById(`slot-${t}`).innerText=v; }
    function clearSlot(t) { forge[t]=null; document.getElementById(`slot-${t}`).innerText=`[${t}]`; }
    function setActiveBlock(id,n) { player.activeBlock=id; alert("Equipped: "+n); }
    function craft(i) {
        if(i==='heal_mud'&&player.resources.dirt>=3) { player.resources.dirt-=3; player.hp=3; alert("Healed!"); }
        else if(i==='wall'&&player.resources.dirt>=1) { player.resources.dirt--; player.blocks[9]+=5; }
        else if(i==='wood'&&player.resources.wood>=2) { player.resources.wood-=2; player.blocks[4]+=5; }
        else if(i==='door'&&player.resources.wood>=2&&player.resources.stone>=1) { 
            player.resources.wood-=2; player.resources.stone-=1; 
            if(!player.blocks[6]) player.blocks[6]=0; 
            player.blocks[6]+=3; 
        }
        updateInvCounts(); renderInventory();
    }
    function updateInvCounts() { document.getElementById('res-frag').innerText=player.fragments; }

    function saveGame() { 
        const saveData = { version: VERSION, player: player, grid: grid, enemies: enemies, gameTick: gameTick };
        localStorage.setItem('wordcraft_save', JSON.stringify(saveData)); alert("Saved!"); 
    }
    
    function loadGame() {
        const savedData = localStorage.getItem('wordcraft_save');
        if(savedData) {
            try {
                const data = JSON.parse(savedData);
                grid = data.grid; enemies = data.enemies; gameTick = data.gameTick;
                player = { 
                    ...player, ...data.player,
                    resources: { ...player.resources, ...data.player.resources },
                    blocks: { ...player.blocks, ...data.player.blocks },
                    quests: { ...player.quests, ...data.player.quests },
                    unlocks: { ...player.unlocks, ...data.player.unlocks }
                };
                if(data.player.roots) player.roots = data.player.roots;
                if(data.player.affixes) player.affixes = data.player.affixes;
                if(data.player.artifacts) player.artifacts = data.player.artifacts;
                alert("Loaded!"); setGameState('playing');
            } catch(e) { console.error(e); alert("Error loading save."); }
        }
    }

    function toggleMap() { if(player.unlocks.map) alert("Map Active!"); else alert("Help Elder Bark first."); }
    function simKey(k,s) { keys[k]=s; if(s) initAudio(); }
</script>
</body>
</html>
